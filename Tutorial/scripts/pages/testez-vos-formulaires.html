<div class="page-header clearfix"><h1 class="pull-left">Testez vos formulaires</h1></div>
							<p>Dans le <a href="les-formulaires">chapitre précédent</a>, nous avons créé notre premier formulaire avec Symfony2. Les utilisateurs sont maintenant en mesure de publier une nouvelle offre d'emploi dans Jobeet mais nous avons manqué de temps avant que nous puissions ajouter quelques tests. C'est ce que nous allons faire.</p>
<br>
<h2>Soumission d'un formulaire</h2>
<p>Ouvrez le fichier <strong>JobControllerTest.php</strong> afin d'ajouter des tests fonctionnels pour la création d'offres et le processus de validation. A la fin du fichier, ajoutez le code suivant pour obtenir la page de création d'offres:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Tests/Controller/JobControllerTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> testJobForm</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $client </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createClient</span><span class="pun">();</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/job/new'</span><span class="pun">);</span></li><li class="L8"><span class="pln">  $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'Ens\JobeetBundle\Controller\JobController::newAction'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'_controller'</span><span class="pun">));</span></li><li class="L9"><span class="pun">}</span></li></ol></pre>
<p>Pour sélectionner des formulaires, nous allons utiliser la méthode <strong>SelectButton()</strong>. Cette méthode peut sélectionner des balises <strong>button</strong> et des boutons <strong>submit</strong>. Une fois que vous avez un Crawler représentant un bouton, appelez la méthode <strong>form()</strong> pour obtenir une instance de <strong>Form</strong> pour le formulaire enveloppant le nœud du bouton:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="pln">$form </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectButton</span><span class="pun">(</span><span class="str">'submit'</span><span class="pun">)-&gt;</span><span class="pln">form</span><span class="pun">();</span></li></ol></pre>
<p>Lorsque vous appelez la méthode <strong>form()</strong>, vous pouvez aussi passer un tableau de valeurs des champs qui sont substituées à celles par défaut:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="pln">$form </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectButton</span><span class="pun">(</span><span class="str">'submit'</span><span class="pun">)-&gt;</span><span class="pln">form</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span></li><li class="L1"><span class="pln">  </span><span class="str">'name'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Fabien'</span><span class="pun">,</span></li><li class="L2"><span class="pln">  </span><span class="str">'my_form[subject]'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Symfony Rocks!'</span></li><li class="L3"><span class="pun">));</span></li></ol></pre>
<p>Mais pour passer les valeurs des champs, nous avons besoin de connaître leurs noms. Si vous ouvrez le code source ou utilisez la <strong>Web Developer Toolbar</strong> de Firefox "Forms &gt; Display Form Details", vous verrez que le nom du champ <strong>company</strong> est <strong>ens_jobeetbundle_jobtype[company]</strong>. Pour rendre les choses un peu plus propres, nous allons changer le format de <strong>job[%s]</strong> en remplaçant la méthode <strong>getName</strong> avec le code suivant à la fin de la classe <strong>JobType</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Form/JobType.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getName</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'job'</span><span class="pun">;</span></li><li class="L6"><span class="pun">}</span></li></ol></pre>
<p>Après ce changement, le nom de la société doit être <strong>job[company]</strong> dans votre navigateur. Il est maintenant temps de sélectionner et transmettre les valeurs valides au formulaire:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Tests/Controller/JobControllerTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> testJobForm</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $client </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createClient</span><span class="pun">();</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/job/new'</span><span class="pun">);</span></li><li class="L8"><span class="pln">  $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'Ens\JobeetBundle\Controller\JobController::newAction'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'_controller'</span><span class="pun">));</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">  $form </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectButton</span><span class="pun">(</span><span class="str">'Preview your job'</span><span class="pun">)-&gt;</span><span class="pln">form</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span></li><li class="L1"><span class="pln">    </span><span class="str">'job[company]'</span><span class="pln">      </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Sensio Labs'</span><span class="pun">,</span></li><li class="L2"><span class="pln">    </span><span class="str">'job[url]'</span><span class="pln">          </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'http://www.sensio.com/'</span><span class="pun">,</span></li><li class="L3"><span class="pln">    </span><span class="str">'job[file]'</span><span class="pln">         </span><span class="pun">=&gt;</span><span class="pln"> __DIR__</span><span class="pun">.</span><span class="str">'/../../../../../web/bundles/ensjobeet/images/sensio-labs.gif'</span><span class="pun">,</span></li><li class="L4"><span class="pln">    </span><span class="str">'job[position]'</span><span class="pln">     </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Developer'</span><span class="pun">,</span></li><li class="L5"><span class="pln">    </span><span class="str">'job[location]'</span><span class="pln">     </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Atlanta, USA'</span><span class="pun">,</span></li><li class="L6"><span class="pln">    </span><span class="str">'job[description]'</span><span class="pln">  </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'You will work with symfony to develop websites for our customers.'</span><span class="pun">,</span></li><li class="L7"><span class="pln">    </span><span class="str">'job[how_to_apply]'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Send me an email'</span><span class="pun">,</span></li><li class="L8"><span class="pln">    </span><span class="str">'job[email]'</span><span class="pln">        </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'for.a.job@example.com'</span><span class="pun">,</span></li><li class="L9"><span class="pln">    </span><span class="str">'job[is_public]'</span><span class="pln">    </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span></li><li class="L0"><span class="pln">  </span><span class="pun">));</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">  $client</span><span class="pun">-&gt;</span><span class="pln">submit</span><span class="pun">(</span><span class="pln">$form</span><span class="pun">);</span></li><li class="L3"><span class="pln">  $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'Ens\JobeetBundle\Controller\JobController::createAction'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'_controller'</span><span class="pun">));</span></li><li class="L4"><span class="pun">}</span></li></ol></pre>
<p>Le navigateur simule aussi l'upload de fichiers si vous passez le chemin absolu du fichier à uploader.</p>
<p>Après avoir soumis le formulaire, nous avons vérifié que l'action exécutée est créée.</p>
<br>
<h2>Test du formulaire</h2>
<p>Si le formulaire est valide, l'offre doit être créée et l'utilisateur redirigé vers la page d'aperçu:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="pln">$client</span><span class="pun">-&gt;</span><span class="pln">followRedirect</span><span class="pun">();</span></li><li class="L1"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'Ens\JobeetBundle\Controller\JobController::previewAction'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'_controller'</span><span class="pun">));</span></li></ol></pre>
<br>
<h2>Test de l'enregistrement dans la BDD</h2>
<p>Finalement, nous voulons vérifier que l'offre a été créée dans la BDD et vérifier que la colonne <strong>is_activated</strong> est définie sur <strong>false</strong> lorsque l'utilisateur n'a pas encore publié.</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="pln">$kernel </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createKernel</span><span class="pun">();</span></li><li class="L1"><span class="pln">$kernel</span><span class="pun">-&gt;</span><span class="pln">boot</span><span class="pun">();</span></li><li class="L2"><span class="pln">$em </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'doctrine.orm.entity_manager'</span><span class="pun">);</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">$query </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">createQuery</span><span class="pun">(</span><span class="str">'SELECT count(j.id) from EnsJobeetBundle:Job j WHERE j.location = :location AND j.is_activated IS NULL AND j.is_public = 0'</span><span class="pun">);</span></li><li class="L5"><span class="pln">$query</span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'location'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Atlanta, USA'</span><span class="pun">);</span></li><li class="L6"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="lit">0</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getSingleScalarResult</span><span class="pun">());</span></li></ol></pre>
<br>
<!--<h2>Test d'erreurs</h2>
<p>Le formulaire de création d'offre fonctionne comme prévu lorsque nous soumettons des valeurs valides. Ajoutons un test pour vérifier le comportement lorsque nous soumettons des données non valides:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="pln">$crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/job/new'</span><span class="pun">);</span></li><li class="L1"><span class="pln">$form </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectButton</span><span class="pun">(</span><span class="str">'Preview your job'</span><span class="pun">)-&gt;</span><span class="pln">form</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span></li><li class="L2"><span class="pln">  </span><span class="str">'job[company]'</span><span class="pln">      </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Sensio Labs'</span><span class="pun">,</span></li><li class="L3"><span class="pln">  </span><span class="str">'job[position]'</span><span class="pln">     </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Developer'</span><span class="pun">,</span></li><li class="L4"><span class="pln">  </span><span class="str">'job[location]'</span><span class="pln">     </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Atlanta, USA'</span><span class="pun">,</span></li><li class="L5"><span class="pln">  </span><span class="str">'job[email]'</span><span class="pln">        </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'not.an.email'</span><span class="pun">,</span></li><li class="L6"><span class="pun">));</span></li><li class="L7"><span class="pln">$crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">submit</span><span class="pun">(</span><span class="pln">$form</span><span class="pun">);</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="com">// check if we have 3 errors</span></li><li class="L0"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.error_list'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">3</span><span class="pun">);</span></li><li class="L1"><span class="com">// check if we have error on job_description field</span></li><li class="L2"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'#job_description'</span><span class="pun">)-&gt;</span><span class="pln">siblings</span><span class="pun">()-&gt;</span><span class="pln">first</span><span class="pun">()-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.error_list'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L3"><span class="com">// check if we have error on job_how_to_apply field</span></li><li class="L4"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'#job_how_to_apply'</span><span class="pun">)-&gt;</span><span class="pln">siblings</span><span class="pun">()-&gt;</span><span class="pln">first</span><span class="pun">()-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.error_list'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L5"><span class="com">// check if we have error on job_email field</span></li><li class="L6"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'#job_email'</span><span class="pun">)-&gt;</span><span class="pln">siblings</span><span class="pun">()-&gt;</span><span class="pln">first</span><span class="pun">()-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.error_list'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li></ol></pre>
-->
<h2>Barre d'administration</h2>
<p>Maintenant, nous avons besoin de tester la barre d'administration sur la page de prévisualisation d'offre. Lorsqu'une offre n'a pas encore été activée, vous pouvez modifier, supprimer ou publier l'offre. Pour tester ces trois actions, il nous faudra d'abord créer une offre. Mais c'est beaucoup de copier/coller. Nous allons donc ajouter une méthode de création d'offre dans la classe <strong>JobControllerTest</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Tests/Controller/JobControllerTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> createJob</span><span class="pun">(</span><span class="pln">$values </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">())</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $client </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createClient</span><span class="pun">();</span></li><li class="L6"><span class="pln">  $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/job/new'</span><span class="pun">);</span></li><li class="L7"><span class="pln">  $form </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectButton</span><span class="pun">(</span><span class="str">'Preview your job'</span><span class="pun">)-&gt;</span><span class="pln">form</span><span class="pun">(</span><span class="pln">array_merge</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span></li><li class="L8"><span class="pln">    </span><span class="str">'job[company]'</span><span class="pln">      </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Sensio Labs'</span><span class="pun">,</span></li><li class="L9"><span class="pln">    </span><span class="str">'job[url]'</span><span class="pln">          </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'http://www.sensio.com/'</span><span class="pun">,</span></li><li class="L0"><span class="pln">    </span><span class="str">'job[position]'</span><span class="pln">     </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Developer'</span><span class="pun">,</span></li><li class="L1"><span class="pln">    </span><span class="str">'job[location]'</span><span class="pln">     </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Atlanta, USA'</span><span class="pun">,</span></li><li class="L2"><span class="pln">    </span><span class="str">'job[description]'</span><span class="pln">  </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'You will work with symfony to develop websites for our customers.'</span><span class="pun">,</span></li><li class="L3"><span class="pln">    </span><span class="str">'job[how_to_apply]'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Send me an email'</span><span class="pun">,</span></li><li class="L4"><span class="pln">    </span><span class="str">'job[email]'</span><span class="pln">        </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'for.a.job@example.com'</span><span class="pun">,</span></li><li class="L5"><span class="pln">   </span><span class="str">'job[is_public]'</span><span class="pln">    </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span></li><li class="L6"><span class="pln">  </span><span class="pun">),</span><span class="pln"> $values</span><span class="pun">));</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln">  $client</span><span class="pun">-&gt;</span><span class="pln">submit</span><span class="pun">(</span><span class="pln">$form</span><span class="pun">);</span></li><li class="L9"><span class="pln">  $client</span><span class="pun">-&gt;</span><span class="pln">followRedirect</span><span class="pun">();</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $client</span><span class="pun">;</span></li><li class="L2"><span class="pun">}</span></li></ol></pre>
<p>La méthode <strong>createJob()</strong> crée une offre, suit la redirection et retourne au navigateur. Vous pouvez aussi passer un tableau de valeurs qui seront fusionnées avec les valeurs par défaut.</p>
<p>Le test de l'action "Publier" est maintenant plus simple:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Tests/Controller/JobControllerTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> testPublishJob</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $client </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createJob</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span><span class="str">'job[position]'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'FOO1'</span><span class="pun">));</span></li><li class="L6"><span class="pln">  $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getCrawler</span><span class="pun">();</span></li><li class="L7"><span class="pln">  $form </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectButton</span><span class="pun">(</span><span class="str">'Publish'</span><span class="pun">)-&gt;</span><span class="pln">form</span><span class="pun">();</span></li><li class="L8"><span class="pln">  $client</span><span class="pun">-&gt;</span><span class="pln">submit</span><span class="pun">(</span><span class="pln">$form</span><span class="pun">);</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">  $kernel </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createKernel</span><span class="pun">();</span></li><li class="L1"><span class="pln">  $kernel</span><span class="pun">-&gt;</span><span class="pln">boot</span><span class="pun">();</span></li><li class="L2"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'doctrine.orm.entity_manager'</span><span class="pun">);</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">  $query </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">createQuery</span><span class="pun">(</span><span class="str">'SELECT count(j.id) from EnsJobeetBundle:Job j WHERE j.position = :position AND j.is_activated = 1'</span><span class="pun">);</span></li><li class="L5"><span class="pln">  $query</span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'position'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'FOO1'</span><span class="pun">);</span></li><li class="L6"><span class="pln">  $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="lit">0</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getSingleScalarResult</span><span class="pun">());</span></li><li class="L7"><span class="pun">}</span></li></ol></pre>
<p>Tester l'action "Supprimer" est assez similaire:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Tests/Controller/JobControllerTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> testDeleteJob</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $client </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createJob</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span><span class="str">'job[position]'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'FOO2'</span><span class="pun">));</span></li><li class="L6"><span class="pln">  $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getCrawler</span><span class="pun">();</span></li><li class="L7"><span class="pln">  $form </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectButton</span><span class="pun">(</span><span class="str">'Delete'</span><span class="pun">)-&gt;</span><span class="pln">form</span><span class="pun">();</span></li><li class="L8"><span class="pln">  $client</span><span class="pun">-&gt;</span><span class="pln">submit</span><span class="pun">(</span><span class="pln">$form</span><span class="pun">);</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">  $kernel </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createKernel</span><span class="pun">();</span></li><li class="L1"><span class="pln">  $kernel</span><span class="pun">-&gt;</span><span class="pln">boot</span><span class="pun">();</span></li><li class="L2"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'doctrine.orm.entity_manager'</span><span class="pun">);</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">  $query </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">createQuery</span><span class="pun">(</span><span class="str">'SELECT count(j.id) from EnsJobeetBundle:Job j WHERE j.position = :position'</span><span class="pun">);</span></li><li class="L5"><span class="pln">  $query</span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'position'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'FOO2'</span><span class="pun">);</span></li><li class="L6"><span class="pln">  $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="lit">0</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getSingleScalarResult</span><span class="pun">());</span></li><li class="L7"><span class="pun">}</span></li></ol></pre>
<br>
<h2>Les tests comme protection</h2>
<p>Quand une offre est publiée, vous ne pouvez plus la modifier. Même si le lien "Modifier" ne s'affiche plus sur la page de prévisualisation, ajoutons quelques tests de cette exigence.</p>
<p>Tout d'abord, ajoutez un autre argument à la méthode <strong>createJob()</strong> pour permettre la publication automatique de l'offre, créez une méthode <strong>getJobByPosition()</strong> qui retourne une offre suivant la valeur de l'intitulé:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Tests/Controller/JobControllerTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> createJob</span><span class="pun">(</span><span class="pln">$values </span><span class="pun">=</span><span class="pln"> array</span><span class="pun">(),</span><span class="pln"> $publish </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $client </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createClient</span><span class="pun">();</span></li><li class="L6"><span class="pln">  $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/job/new'</span><span class="pun">);</span></li><li class="L7"><span class="pln">  $form </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectButton</span><span class="pun">(</span><span class="str">'Preview your job'</span><span class="pun">)-&gt;</span><span class="pln">form</span><span class="pun">(</span><span class="pln">array_merge</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span></li><li class="L8"><span class="pln">    </span><span class="str">'job[company]'</span><span class="pln">      </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Sensio Labs'</span><span class="pun">,</span></li><li class="L9"><span class="pln">    </span><span class="str">'job[url]'</span><span class="pln">          </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'http://www.sensio.com/'</span><span class="pun">,</span></li><li class="L0"><span class="pln">    </span><span class="str">'job[position]'</span><span class="pln">     </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Developer'</span><span class="pun">,</span></li><li class="L1"><span class="pln">    </span><span class="str">'job[location]'</span><span class="pln">     </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Atlanta, USA'</span><span class="pun">,</span></li><li class="L2"><span class="pln">    </span><span class="str">'job[description]'</span><span class="pln">  </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'You will work with symfony to develop websites for our customers.'</span><span class="pun">,</span></li><li class="L3"><span class="pln">    </span><span class="str">'job[how_to_apply]'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Send me an email'</span><span class="pun">,</span></li><li class="L4"><span class="pln">    </span><span class="str">'job[email]'</span><span class="pln">        </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'for.a.job@example.com'</span><span class="pun">,</span></li><li class="L5"><span class="pln">    </span><span class="str">'job[is_public]'</span><span class="pln">    </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span></li><li class="L6"><span class="pln">  </span><span class="pun">),</span><span class="pln"> $values</span><span class="pun">));</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln">  $client</span><span class="pun">-&gt;</span><span class="pln">submit</span><span class="pun">(</span><span class="pln">$form</span><span class="pun">);</span></li><li class="L9"><span class="pln">  $client</span><span class="pun">-&gt;</span><span class="pln">followRedirect</span><span class="pun">();</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="pln">  </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">$publish</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">    $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getCrawler</span><span class="pun">();</span></li><li class="L3"><span class="pln">    $form </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectButton</span><span class="pun">(</span><span class="str">'Publish'</span><span class="pun">)-&gt;</span><span class="pln">form</span><span class="pun">();</span></li><li class="L4"><span class="pln">    $client</span><span class="pun">-&gt;</span><span class="pln">submit</span><span class="pun">(</span><span class="pln">$form</span><span class="pun">);</span></li><li class="L5"><span class="pln">    $client</span><span class="pun">-&gt;</span><span class="pln">followRedirect</span><span class="pun">();</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $client</span><span class="pun">;</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getJobByPosition</span><span class="pun">(</span><span class="pln">$position</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  $kernel </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createKernel</span><span class="pun">();</span></li><li class="L4"><span class="pln">  $kernel</span><span class="pun">-&gt;</span><span class="pln">boot</span><span class="pun">();</span></li><li class="L5"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'doctrine.orm.entity_manager'</span><span class="pun">);</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  $query </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">createQuery</span><span class="pun">(</span><span class="str">'SELECT j from EnsJobeetBundle:Job j WHERE j.position = :position'</span><span class="pun">);</span></li><li class="L8"><span class="pln">  $query</span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'position'</span><span class="pun">,</span><span class="pln"> $position</span><span class="pun">);</span></li><li class="L9"><span class="pln">  $query</span><span class="pun">-&gt;</span><span class="pln">setMaxResults</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getSingleResult</span><span class="pun">();</span></li><li class="L1"><span class="pun">}</span></li></ol></pre>
<p>Si une offre est publiée, la page de modification doit retourner un code d'état 404:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Controller/JobController.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> editAction</span><span class="pun">(</span><span class="pln">$token</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getDoctrine</span><span class="pun">()-&gt;</span><span class="pln">getEntityManager</span><span class="pun">();</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  $entity </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job'</span><span class="pun">)-&gt;</span><span class="pln">findOneByToken</span><span class="pun">(</span><span class="pln">$token</span><span class="pun">);</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">$entity</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="kwd">throw</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createNotFoundException</span><span class="pun">(</span><span class="str">'Unable to find Job entity.'</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$entity</span><span class="pun">-&gt;</span><span class="pln">getIsActivated</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="kwd">throw</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createNotFoundException</span><span class="pun">(</span><span class="str">'Job is activated and cannot be edited.'</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  </span><span class="com">// ...</span></li><li class="L8"><span class="pun">}</span></li></ol></pre>
<br>
<h2>Retour vers le futur dans le test</h2>
<p>Quand une offre expire dans moins de cinq jours, ou si elle est déjà expirée, l'utilisateur peut étendre la validité de l'offre pour 30 jours à compter de la date actuelle.</p>
<p>Le test de cette exigence dans un navigateur n'est pas facile car la date d'expiration est automatiquement activée lorsque l'offre est créée pour 30 jours dans le futur. Ainsi, lors de l'obtention de la page de l'offre, le lien pour prolonger l'offre n'est pas présent. Bien sûr, vous pouvez adapter la date d'expiration dans la BDD ou modifier le modèle pour afficher en permanence le lien, mais c'est fastidieux et source d'erreurs. Comme vous l'avez déjà deviné, l'écriture de tests va nous aider une fois de plus.</p>
<p>Comme toujours, nous devons ajouter une nouvelle route pour la méthode <strong>extend</strong> en premier:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># src/Ens/JobeetBundle/Resources/config/routing/job.yml</span></li><li class="L1"><span class="com"># ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">ens_job_extend:</span></li><li class="L4"><span class="pln">    </span><span class="kwd">pattern: </span><span class="pln"> /{token}/extend</span></li><li class="L5"><span class="pln">    </span><span class="kwd">defaults: </span><span class="pln">{ </span><span class="kwd">_controller: </span><span class="str">"EnsJobeetBundle:Job:extend"</span><span class="pln"> }</span></li><li class="L6"><span class="pln">    </span><span class="kwd">requirements: </span><span class="pln">{ </span><span class="kwd">_method: </span><span class="pln">post }</span></li></ol></pre>
<p>Ensuite, remplacez le lien "Extend" dans le template <strong>admin.html.twig</strong> avec le formulaire <strong>extend</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">&lt;!-- src/Ens/JobeetBundle/Resources/views/Job/admin.html.twig --&gt;</span></li><li class="L1"><span class="com">&lt;!-- ... --&gt;</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">{% if job.expiresSoon %}</span></li><li class="L4"><span class="pln">  </span><span class="tag">&lt;form</span><span class="pln"> </span><span class="atn">action</span><span class="pun">=</span><span class="atv">"{{ path('ens_job_extend', { 'token': job.token }) }}"</span><span class="pln"> </span><span class="atn">method</span><span class="pun">=</span><span class="atv">"post"</span><span class="tag">&gt;</span></li><li class="L5"><span class="pln">    {{ form_widget(extend_form) }}</span></li><li class="L6"><span class="pln">    </span><span class="tag">&lt;button</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"submit"</span><span class="tag">&gt;</span><span class="pln">Extend</span><span class="tag">&lt;/button&gt;</span><span class="pln"> for another 30 days</span></li><li class="L7"><span class="pln">  </span><span class="tag">&lt;/form&gt;</span></li><li class="L8"><span class="pln">{% endif %}</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="com">&lt;!-- ... --&gt;</span></li></ol></pre>
<p>Ensuite, créez l'action <strong>extend</strong> et le formulaire <strong>extend</strong>:</p>
<pre class="prettyprint linenums">
// src/Ens/JobeetBundle/Controller/JobController.php
// ...
 
public function extendAction(Request $request, $token)
{
  $form = $this->createExtendForm($token);
  
  $form->bind($request);
 
  if ($form->isValid()) {
    $em = $this->getDoctrine()->getEntityManager();
    $entity = $em->getRepository('EnsJobeetBundle:Job')->findOneByToken($token);
 
    if (!$entity) {
      throw $this->createNotFoundException('Unable to find Job entity.');
    }
 
    if (!$entity->extend()) {
      throw $this->createNotFoundException('Unable to find extend the Job.');
    }
 
    $em->persist($entity);
    $em->flush();
 
    $this->get('session')->setFlash('notice', sprintf('Your job validity has been extended until %s.', $entity->getExpiresAt()->format('m/d/Y')));
  }
 
  return $this->redirect($this->generateUrl('ens_job_preview', array(
    'company' => $entity->getCompanySlug(),
    'location' => $entity->getLocationSlug(),
    'token' => $entity->getToken(),
    'position' => $entity->getPositionSlug()
  )));
}
 
private function createExtendForm($token)
{
  return $this->createFormBuilder(array('token' => $token))
    ->add('token', 'hidden')
    ->getForm()
  ;
}
</pre>
<p>En outre, ajoutez le formulaire <strong>extend</strong> à l'action <strong>preview</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Controller/JobController.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> previewAction</span><span class="pun">(</span><span class="pln">$token</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getDoctrine</span><span class="pun">()-&gt;</span><span class="pln">getEntityManager</span><span class="pun">();</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  $entity </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job'</span><span class="pun">)-&gt;</span><span class="pln">findOneByToken</span><span class="pun">(</span><span class="pln">$token</span><span class="pun">);</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">$entity</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="kwd">throw</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createNotFoundException</span><span class="pun">(</span><span class="str">'Unable to find Job entity.'</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">  $deleteForm </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createDeleteForm</span><span class="pun">(</span><span class="pln">$entity</span><span class="pun">-&gt;</span><span class="pln">getId</span><span class="pun">());</span></li><li class="L4"><span class="pln">  $publishForm </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createPublishForm</span><span class="pun">(</span><span class="pln">$entity</span><span class="pun">-&gt;</span><span class="pln">getToken</span><span class="pun">());</span></li><li class="L5"><span class="pln">  $extendForm </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createExtendForm</span><span class="pun">(</span><span class="pln">$entity</span><span class="pun">-&gt;</span><span class="pln">getToken</span><span class="pun">());</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">render</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job:show.html.twig'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span></li><li class="L8"><span class="pln">    </span><span class="str">'entity'</span><span class="pln">      </span><span class="pun">=&gt;</span><span class="pln"> $entity</span><span class="pun">,</span></li><li class="L9"><span class="pln">    </span><span class="str">'delete_form'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $deleteForm</span><span class="pun">-&gt;</span><span class="pln">createView</span><span class="pun">(),</span></li><li class="L0"><span class="pln">    </span><span class="str">'publish_form'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $publishForm</span><span class="pun">-&gt;</span><span class="pln">createView</span><span class="pun">(),</span></li><li class="L1"><span class="pln">    </span><span class="str">'extend_form'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $extendForm</span><span class="pun">-&gt;</span><span class="pln">createView</span><span class="pun">(),</span></li><li class="L2"><span class="pln">  </span><span class="pun">));</span></li><li class="L3"><span class="pun">}</span></li></ol></pre>
<p>Comme prévu par l'action, la méthode <strong>extend()</strong> de <strong>Job</strong> retourne <strong>true</strong> si l'offre a été prolongée ou <strong>false</strong> sinon:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/Jobeetbundle/Entity/Job.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> extend</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">expiresSoon</span><span class="pun">())</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">  $this</span><span class="pun">-&gt;</span><span class="pln">expires_at </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> \DateTime</span><span class="pun">(</span><span class="pln">date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="lit">86400</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">30</span><span class="pun">));</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></li><li class="L3"><span class="pun">}</span></li></ol></pre>
<p>Enfin, ajoutez un scénario de test:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Tests/Controller/JobControllerTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> testExtendJob</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="com">// A job validity cannot be extended before the job expires soon</span></li><li class="L6"><span class="pln">  $client </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createJob</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span><span class="str">'job[position]'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'FOO4'</span><span class="pun">),</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">);</span></li><li class="L7"><span class="pln">  $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getCrawler</span><span class="pun">();</span></li><li class="L8"><span class="pln">  $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'input[type=submit]:contains("Extend")'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">  </span><span class="com">// A job validity can be extended when the job expires soon</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">  </span><span class="com">// Create a new FOO5 job</span></li><li class="L3"><span class="pln">  $client </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createJob</span><span class="pun">(</span><span class="pln">array</span><span class="pun">(</span><span class="str">'job[position]'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'FOO5'</span><span class="pun">),</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="com">// Get the job and change the expire date to today</span></li><li class="L5"><span class="pln">  $kernel </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createKernel</span><span class="pun">();</span></li><li class="L6"><span class="pln">  $kernel</span><span class="pun">-&gt;</span><span class="pln">boot</span><span class="pun">();</span></li><li class="L7"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'doctrine.orm.entity_manager'</span><span class="pun">);</span></li><li class="L8"><span class="pln">  $job </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job'</span><span class="pun">)-&gt;</span><span class="pln">findOneByPosition</span><span class="pun">(</span><span class="str">'FOO5'</span><span class="pun">);</span></li><li class="L9"><span class="pln">  $job</span><span class="pun">-&gt;</span><span class="pln">setExpiresAt</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> \DateTime</span><span class="pun">());</span></li><li class="L0"><span class="pln">  $em</span><span class="pun">-&gt;</span><span class="pln">flush</span><span class="pun">();</span></li><li class="L1"><span class="pln">  </span><span class="com">// Go to the preview page and extend the job</span></li><li class="L2"><span class="pln">  $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> sprintf</span><span class="pun">(</span><span class="str">'/job/%s/%s/%s/%s'</span><span class="pun">,</span><span class="pln"> $job</span><span class="pun">-&gt;</span><span class="pln">getCompanySlug</span><span class="pun">(),</span><span class="pln"> $job</span><span class="pun">-&gt;</span><span class="pln">getLocationSlug</span><span class="pun">(),</span><span class="pln"> $job</span><span class="pun">-&gt;</span><span class="pln">getToken</span><span class="pun">(),</span><span class="pln"> $job</span><span class="pun">-&gt;</span><span class="pln">getPositionSlug</span><span class="pun">()));</span></li><li class="L3"><span class="pln">  $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getCrawler</span><span class="pun">();</span></li><li class="L4"><span class="pln">  $form </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectButton</span><span class="pun">(</span><span class="str">'Extend'</span><span class="pun">)-&gt;</span><span class="pln">form</span><span class="pun">();</span></li><li class="L5"><span class="pln">  $client</span><span class="pun">-&gt;</span><span class="pln">submit</span><span class="pun">(</span><span class="pln">$form</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="com">// Reload the job from db</span></li><li class="L7"><span class="pln">  $job </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getJobByPosition</span><span class="pun">(</span><span class="str">'FOO5'</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="com">// Check the expiration date</span></li><li class="L9"><span class="pln">  $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$job</span><span class="pun">-&gt;</span><span class="pln">getExpiresAt</span><span class="pun">()-&gt;</span><span class="pln">format</span><span class="pun">(</span><span class="str">'y/m/d'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'y/m/d'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="lit">86400</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">30</span><span class="pun">));</span></li><li class="L0"><span class="pun">}</span></li></ol></pre>
<br>
<h2>Tâches de maintenance</h2>
<p>Même si Symfony est un framework web, il est livré avec un outil de ligne de commande. Vous l'avez déjà utilisé pour créer la structure de répertoire par défaut du paquet de l'application et générer des fichiers divers pour le modèle. Ajouter une nouvelle commande est assez facile.</p>
<p>Lorsqu'un utilisateur crée une offre, il faut l'activer pour la mettre en ligne. Sinon, la BDD grandira avec de vieilles offres. Nous allons créer une commande qui supprime de la BDD les vieilles offres. Cette commande devra être exécutée régulièrement dans une <a href="http://fr.wikipedia.org/wiki/Crontab" target="_blank">tâche cron</a>.</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Command/JobeetCleanupCommand.php</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="kwd">namespace</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Command</span><span class="pun">;</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Symfony</span><span class="pln">\Bundle\FrameworkBundle\Command\ContainerAwareCommand</span><span class="pun">;</span></li><li class="L5"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Symfony</span><span class="pln">\Component\Console\Input\InputArgument</span><span class="pun">;</span></li><li class="L6"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Symfony</span><span class="pln">\Component\Console\Input\InputInterface</span><span class="pun">;</span></li><li class="L7"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Symfony</span><span class="pln">\Component\Console\Input\InputOption</span><span class="pun">;</span></li><li class="L8"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Symfony</span><span class="pln">\Component\Console\Output\OutputInterface</span><span class="pun">;</span></li><li class="L9"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Entity\Job</span><span class="pun">;</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="kwd">class</span><span class="pln"> </span><span class="typ">JobeetCleanupCommand</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">ContainerAwareCommand</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">  </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> configure</span><span class="pun">()</span></li><li class="L4"><span class="pln">  </span><span class="pun">{</span></li><li class="L5"><span class="pln">    $this</span></li><li class="L6"><span class="pln">      </span><span class="pun">-&gt;</span><span class="pln">setName</span><span class="pun">(</span><span class="str">'ens:jobeet:cleanup'</span><span class="pun">)</span></li><li class="L7"><span class="pln">      </span><span class="pun">-&gt;</span><span class="pln">setDescription</span><span class="pun">(</span><span class="str">'Cleanup Jobeet database'</span><span class="pun">)</span></li><li class="L8"><span class="pln">      </span><span class="pun">-&gt;</span><span class="pln">addArgument</span><span class="pun">(</span><span class="str">'days'</span><span class="pun">,</span><span class="pln"> </span><span class="typ">InputArgument</span><span class="pun">::</span><span class="pln">OPTIONAL</span><span class="pun">,</span><span class="pln"> </span><span class="str">'The email'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">90</span><span class="pun">)</span></li><li class="L9"><span class="pln">    </span><span class="pun">;</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">  </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> execute</span><span class="pun">(</span><span class="typ">InputInterface</span><span class="pln"> $input</span><span class="pun">,</span><span class="pln"> </span><span class="typ">OutputInterface</span><span class="pln"> $output</span><span class="pun">)</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">    $days </span><span class="pun">=</span><span class="pln"> $input</span><span class="pun">-&gt;</span><span class="pln">getArgument</span><span class="pun">(</span><span class="str">'days'</span><span class="pun">);</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln">    $em </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'doctrine'</span><span class="pun">)-&gt;</span><span class="pln">getEntityManager</span><span class="pun">();</span></li><li class="L7"><span class="pln">    $nb </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job'</span><span class="pun">)-&gt;</span><span class="pln">cleanup</span><span class="pun">(</span><span class="pln">$days</span><span class="pun">);</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">    $output</span><span class="pun">-&gt;</span><span class="pln">writeln</span><span class="pun">(</span><span class="pln">sprintf</span><span class="pun">(</span><span class="str">'Removed %d stale jobs'</span><span class="pun">,</span><span class="pln"> $nb</span><span class="pun">));</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pun">}</span></li></ol></pre>
<p>Vous devrez ajouter la méthode <strong>cleanup</strong> à la classe <strong>JobRepository</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Repository/JobRepository.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> cleanup</span><span class="pun">(</span><span class="pln">$days</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $query </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createQueryBuilder</span><span class="pun">(</span><span class="str">'j'</span><span class="pun">)</span></li><li class="L6"><span class="pln">    </span><span class="pun">-&gt;</span><span class="kwd">delete</span><span class="pun">()</span></li><li class="L7"><span class="pln">    </span><span class="pun">-&gt;</span><span class="kwd">where</span><span class="pun">(</span><span class="str">'j.is_activated IS NULL'</span><span class="pun">)</span></li><li class="L8"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">andWhere</span><span class="pun">(</span><span class="str">'j.created_at &lt; :created_at'</span><span class="pun">)</span><span class="pln">     </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'created_at'</span><span class="pun">,</span><span class="pln">  date</span><span class="pun">(</span><span class="str">'Y-m-d'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="lit">86400</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> $days</span><span class="pun">))</span></li><li class="L9"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">getQuery</span><span class="pun">();</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">execute</span><span class="pun">();</span></li><li class="L2"><span class="pun">}</span></li></ol></pre>
<p>Pour lancer la commande, exécutez la commande suivante à partir du dossier de projet:</p>
<pre>php app/console ens:jobeet:cleanup</pre>
<p>ou</p>
<pre>php app/console ens:jobeet:cleanup 10</pre>
<p>pour supprimer de vieilles offres de plus de 10 jours.</p>
<br>
<p class="clearfix noprint">
	<a href="les-formulaires" class="btn btn-success pull-left">Chapitre précédent</a>
	<a href="le-paquet-admin" class="btn btn-success pull-right">Chapitre suivant</a>
</p>														<p class="link_source noprint"><a href="http://www.ens.ro/2012/06/22/symfony2-jobeet-day-11-testing-your-forms/" target="_blank">» Lire l'article original</a></p>
																					<br>