<div class="page-header clearfix"><h1 class="pull-left">Les tests unitaires</h1></div>
							<h2>Les tests dans Symfony2</h2>
<p>Il existe deux types de tests automatisés dans Symfony: les <strong>tests unitaires</strong> et les <strong>tests fonctionnels</strong>. Les tests unitaires vérifient que chaque méthode et fonction fonctionne correctement. Chaque test doit être aussi indépendant que possible des autres. D'autre part, les tests fonctionnels vérifient que l'application résultante se comporte correctement dans son ensemble.</p>
<p>Les tests unitaires seront couverts dans ce chapitre, alors que le prochain chapitre sera consacré aux tests fonctionnels.</p>
<p>Symfony2 s'intègre à une bibliothèque indépendante, <strong>PHPUnit</strong>, pour vous donner un framework de tests riche. Pour exécuter des tests, vous devrez <a href="http://www.phpunit.de/manual/current/fr/installation.html" target="_blank">installer PHPUnit</a> 3.5.11 ou une version ultérieure.</p>
<p>Chaque test - qu'il s'agisse d'un test unitaire ou un test fonctionnel - est une classe PHP qui doit se situer dans un sous-répertoire <strong>Tests/</strong> de vos paquets. Si vous suivez cette règle, vous pouvez exécuter tous les tests de votre application avec la commande suivante:</p>
<pre>$ phpunit -c app/</pre>
<p>L'option <strong>-c</strong> indique à PHPUnit de chercher un fichier de configuration dans le répertoire <strong>app/</strong>. Si vous êtes curieux de connaître les options de PHPUnit, consultez le fichier <strong>app/phpunit.xml.dist</strong>.</p>
<br>
<h2>Tests unitaires</h2>
<p>Un test unitaire est généralement un test contre une classe PHP spécifique. Commençons par écrire des tests pour la méthode <strong>Jobeet::slugify()</strong>.</p>
<p>Créez un nouveau fichier, <strong>JobeetTest.php</strong>, dans le répertoire <strong>src/Ens/JobeetBundle/Tests/Utils</strong>. Par convention, le sous-répertoire <strong>Tests/</strong> doit répliquer le répertoire de votre paquet. Donc, quand nous testons une classe dans le répertoire <strong>Utils/</strong> de notre paquet, nous avons mis le test dans le répertoire <strong>Tests/Utils/</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Tests/Utils/JobeetTest.php</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="kwd">namespace</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Tests\Utils</span><span class="pun">;</span></li><li class="L3"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Utils\Jobeet</span><span class="pun">;</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="kwd">class</span><span class="pln"> </span><span class="typ">JobeetTest</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> \P</span><span class="typ">HPUnit_Framework_TestCase</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> testSlugify</span><span class="pun">()</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'sensio'</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Jobeet</span><span class="pun">::</span><span class="pln">slugify</span><span class="pun">(</span><span class="str">'Sensio'</span><span class="pun">));</span></li><li class="L0"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'sensio-labs'</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Jobeet</span><span class="pun">::</span><span class="pln">slugify</span><span class="pun">(</span><span class="str">'sensio labs'</span><span class="pun">));</span></li><li class="L1"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'sensio-labs'</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Jobeet</span><span class="pun">::</span><span class="pln">slugify</span><span class="pun">(</span><span class="str">'sensio   labs'</span><span class="pun">));</span></li><li class="L2"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'paris-france'</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Jobeet</span><span class="pun">::</span><span class="pln">slugify</span><span class="pun">(</span><span class="str">'paris,france'</span><span class="pun">));</span></li><li class="L3"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'sensio'</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Jobeet</span><span class="pun">::</span><span class="pln">slugify</span><span class="pun">(</span><span class="str">'  sensio'</span><span class="pun">));</span></li><li class="L4"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'sensio'</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Jobeet</span><span class="pun">::</span><span class="pln">slugify</span><span class="pun">(</span><span class="str">'sensio  '</span><span class="pun">));</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span></li><li class="L6"><span class="pun">}</span></li></ol></pre>
<p>Pour exécuter ce test, vous pouvez utiliser la commande suivante:</p>
<pre>phpunit -c app/ src/Ens/JobeetBundle/Tests/Utils/JobeetTest</pre>
<p>Comme tout devrait fonctionner correctement, vous devriez obtenir le résultat suivant:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="typ">PHPUnit</span><span class="pln"> </span><span class="lit">3.6</span><span class="pun">.</span><span class="lit">10</span><span class="pln"> </span><span class="kwd">by</span><span class="pln"> </span><span class="typ">Sebastian</span><span class="pln"> </span><span class="typ">Bergmann</span><span class="pun">.</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="typ">Configuration</span><span class="pln"> read </span><span class="kwd">from</span><span class="pln"> </span><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">dragos</span><span class="pun">/</span><span class="pln">work</span><span class="pun">/</span><span class="pln">jobeet</span><span class="pun">/</span><span class="pln">app</span><span class="pun">/</span><span class="pln">phpunit</span><span class="pun">.</span><span class="pln">xml</span><span class="pun">.</span><span class="pln">dist</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pun">.</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="typ">Time</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> seconds</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Memory</span><span class="pun">:</span><span class="pln"> </span><span class="lit">3.50Mb</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln">OK </span><span class="pun">(</span><span class="lit">1</span><span class="pln"> test</span><span class="pun">,</span><span class="pln"> </span><span class="lit">6</span><span class="pln"> assertions</span><span class="pun">)</span></li></ol></pre>
<p>Pour une liste complète des <a href="http://www.phpunit.de/manual/current/fr/writing-tests-for-phpunit.html#writing-tests-for-phpunit.assertions" target="_blank">assertions</a>, vous pouvez consulter la <a href="http://www.phpunit.de/manual/current/fr/" target="_blank">documentation de PHPUnit</a>.</p>
<br>
<h2>Ajout de tests pour de nouvelles fonctionnalités</h2>
<p>Le jeton pour une chaîne vide est une chaîne vide. Vous pouvez le tester, ça va marcher. Mais une chaîne vide dans une URL n'est pas une bonne idée. Nous allons changer la méthode <strong>slugify()</strong> de sorte qu'elle retourne la chaîne "<strong>n-a</strong>" dans le cas d'une chaîne vide.</p>
<p>Vous pouvez écrire le premier test, puis mettre à jour la méthode, ou l'inverse. C'est vraiment une question de goût mais l'écriture du test en premier vous donne l'assurance que votre code implémente réellement ce que vous avez prévu:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Tests/Utils/JobeetTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'n-a'</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Jobeet</span><span class="pun">::</span><span class="pln">slugify</span><span class="pun">(</span><span class="str">''</span><span class="pun">));</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="com">// ...</span></li></ol></pre>
<p>Maintenant, si nous réexécutons le test, nous aurons un échec:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="typ">PHPUnit</span><span class="pln"> </span><span class="lit">3.6</span><span class="pun">.</span><span class="lit">10</span><span class="pln"> </span><span class="kwd">by</span><span class="pln"> </span><span class="typ">Sebastian</span><span class="pln"> </span><span class="typ">Bergmann</span><span class="pun">.</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="typ">Configuration</span><span class="pln"> read </span><span class="kwd">from</span><span class="pln"> </span><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">dragos</span><span class="pun">/</span><span class="pln">work</span><span class="pun">/</span><span class="pln">jobeet</span><span class="pun">/</span><span class="pln">app</span><span class="pun">/</span><span class="pln">phpunit</span><span class="pun">.</span><span class="pln">xml</span><span class="pun">.</span><span class="pln">dist</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">F</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="typ">Time</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> seconds</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Memory</span><span class="pun">:</span><span class="pln"> </span><span class="lit">3.50Mb</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="typ">There</span><span class="pln"> was </span><span class="lit">1</span><span class="pln"> failure</span><span class="pun">:</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Tests\Utils\JobeetTest</span><span class="pun">::</span><span class="pln">testSlugify</span></li><li class="L1"><span class="typ">Failed</span><span class="pln"> asserting that two strings are equal</span><span class="pun">.</span></li><li class="L2"><span class="pun">---</span><span class="pln"> </span><span class="typ">Expected</span></li><li class="L3"><span class="pun">+++</span><span class="pln"> </span><span class="typ">Actual</span></li><li class="L4"><span class="pun">@@</span><span class="pln"> </span><span class="pun">@@</span></li><li class="L5"><span class="pun">-</span><span class="str">'n-a'</span></li><li class="L6"><span class="pun">+</span><span class="str">''</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">dragos</span><span class="pun">/</span><span class="pln">work</span><span class="pun">/</span><span class="pln">jobeet</span><span class="pun">/</span><span class="pln">src</span><span class="pun">/</span><span class="typ">Ens</span><span class="pun">/</span><span class="typ">JobeetBundle</span><span class="pun">/</span><span class="typ">Tests</span><span class="pun">/</span><span class="typ">Utils</span><span class="pun">/</span><span class="typ">JobeetTest</span><span class="pun">.</span><span class="pln">php</span><span class="pun">:</span><span class="lit">17</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">FAILURES</span><span class="pun">!</span></li><li class="L1"><span class="typ">Tests</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Assertions</span><span class="pun">:</span><span class="pln"> </span><span class="lit">7</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Failures</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1.</span></li></ol></pre>
<p>Maintenant, modifiez la classe <strong>Jobeet</strong> et ajoutez la condition suivante au début:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Utils/Jobeet.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> slugify</span><span class="pun">(</span><span class="pln">$text</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">empty</span><span class="pun">(</span><span class="pln">$text</span><span class="pun">))</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'n-a'</span><span class="pun">;</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="com">// ...</span></li><li class="L1"><span class="pun">}</span></li></ol></pre>
<p>Le test doit maintenant passer comme prévu, et vous pourrez profiter de la barre verte.</p>
<br>
<h2>Ajout de tests à cause d'un bug</h2>
<p>Disons que le temps a passé et l'un de vos utilisateurs vous rapporte un bug bizarre: certains liens des offres pointent vers une page d'erreur 404. Après quelques recherches, vous trouverez que, pour une raison quelconque, ces offres ont un jeton société, intitulé ou lieu vide.</p>
<p>Comment est-ce possible?</p>
<p>Vous regardez à travers les enregistrements de la BDD et les colonnes ne sont absolument pas vide. Vous y réfléchissez un moment, et hop, vous trouvez la cause. Lorsqu'une chaîne ne contient que des caractères non-ASCII, la méthode <strong>slugify()</strong> la convertit en une chaîne vide. Je suis si heureux d'avoir trouvé la cause, vous ouvrez la classe <strong>Jobeet</strong> et corrigez le problème tout de suite. C'est une mauvaise idée. Tout d'abord, nous allons ajouter un test:</p>
<pre>$this-&gt;assertEquals('n-a', Jobeet::slugify(' - '));</pre>
<p>Après avoir vérifié que le test ne passe pas, modifiez la classe <strong>Jobeet</strong> et déplacez la vérification de la chaîne vide à la fin de la méthode:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> slugify</span><span class="pun">(</span><span class="pln">$text</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">// ...</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">empty</span><span class="pun">(</span><span class="pln">$text</span><span class="pun">))</span></li><li class="L5"><span class="pln">  </span><span class="pun">{</span></li><li class="L6"><span class="pln">     </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'n-a'</span><span class="pun">;</span></li><li class="L7"><span class="pln">  </span><span class="pun">}</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $text</span><span class="pun">;</span></li><li class="L0"><span class="pun">}</span></li></ol></pre>
<p>Le nouveau test passe désormais, comme tous les autres. La méthode <strong>slugify()</strong> a eu un bug en dépit de notre couverture à 100%.</p>
<p>Vous ne pouvez pas penser à tous les cas lors de l'écriture des tests, et c'est très bien. Mais quand vous en découvrez un, vous devez écrire un test avant de corriger votre code. Cela signifie également que votre code va s'améliorer au fil du temps, ce qui est toujours une bonne chose.</p>
<br>
<h2>Vers une meilleure méthode slugify()</h2>
<p>Vous savez probablement que Symfony a été créé par des français, nous allons donc ajouter un test avec un mot français qui contient un accent:</p>
<pre>$this-&gt;assertEquals('developpeur-web', Jobeet::slugify('Développeur Web'));</pre>
<p>Le test doit échouer. Au lieu de remplacer é par e, la méthode <strong>slugify()</strong> l'a remplacé par un tiret (-). C'est un problème compliqué, appelé <a href="http://fr.wikipedia.org/wiki/Transcription_et_translitt%C3%A9ration" target="_blank">translittération</a>. Heureusement, la <a href="http://php.net/manual/fr/book.iconv.php" target="_blank">bibliothèque iconv</a>, si elle est installée, va faire le travail pour nous. Remplacez le code de la méthode <strong>slugify()</strong> par ce qui suit:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> slugify</span><span class="pun">(</span><span class="pln">$text</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">// replace non letter or digits by -</span></li><li class="L3"><span class="pln">  $text </span><span class="pun">=</span><span class="pln"> preg_replace</span><span class="pun">(</span><span class="str">'#[^\\pL\d]+#u'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'-'</span><span class="pun">,</span><span class="pln"> $text</span><span class="pun">);</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">  </span><span class="com">// trim</span></li><li class="L6"><span class="pln">  $text </span><span class="pun">=</span><span class="pln"> trim</span><span class="pun">(</span><span class="pln">$text</span><span class="pun">,</span><span class="pln"> </span><span class="str">'-'</span><span class="pun">);</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln">  </span><span class="com">// transliterate</span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">function_exists</span><span class="pun">(</span><span class="str">'iconv'</span><span class="pun">))</span></li><li class="L0"><span class="pln">  </span><span class="pun">{</span></li><li class="L1"><span class="pln">    $text </span><span class="pun">=</span><span class="pln"> iconv</span><span class="pun">(</span><span class="str">'utf-8'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'us-ascii//TRANSLIT'</span><span class="pun">,</span><span class="pln"> $text</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">  </span><span class="com">// lowercase</span></li><li class="L5"><span class="pln">  $text </span><span class="pun">=</span><span class="pln"> strtolower</span><span class="pun">(</span><span class="pln">$text</span><span class="pun">);</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  </span><span class="com">// remove unwanted characters</span></li><li class="L8"><span class="pln">  $text </span><span class="pun">=</span><span class="pln"> preg_replace</span><span class="pun">(</span><span class="str">'#[^-\w]+#'</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> $text</span><span class="pun">);</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">empty</span><span class="pun">(</span><span class="pln">$text</span><span class="pun">))</span></li><li class="L1"><span class="pln">  </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'n-a'</span><span class="pun">;</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $text</span><span class="pun">;</span></li><li class="L6"><span class="pun">}</span></li></ol></pre>
<p>N'oubliez pas de sauvegarder tous vos fichiers PHP avec l'encodage UTF-8, car c'est l'encodage par défaut de Symfony, et celui utilisé par <strong>iconv</strong> pour faire la translitération.</p>
<p>Modifiez également le fichier de test pour n'exécuter le test que si <strong>iconv</strong> est disponible:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">function_exists</span><span class="pun">(</span><span class="str">'iconv'</span><span class="pun">))</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'developpeur-web'</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Jobeet</span><span class="pun">::</span><span class="pln">slugify</span><span class="pun">(</span><span class="str">'Développeur Web'</span><span class="pun">));</span></li><li class="L3"><span class="pun">}</span></li></ol></pre>
<br>
<p class="clearfix noprint">
	<a href="jouons-avec-la-page-categorie" class="btn btn-success pull-left">Chapitre précédent</a>
	<a href="les-tests-fonctionnels" class="btn btn-success pull-right">Chapitre suivant</a>
</p>														<p class="link_source noprint"><a href="http://www.ens.ro/2012/04/18/symfony2-jobeet-day-8-the-unit-tests/" target="_blank">» Lire l'article original</a></p>
																					<br>