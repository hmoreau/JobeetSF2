<div class="page-header clearfix"><h1 class="pull-left">Les tests fonctionnels</h1></div>
							<p>Les tests fonctionnels sont un excellent outil pour tester votre application de bout en bout: de la demande faite par un navigateur jusqu'à la réponse envoyée par le serveur. Ils testent toutes les couches d'une application: le routage, le modèle, les actions et les templates. Ils sont très similaires à ce que vous avez probablement déjà fait manuellement: chaque fois que vous ajoutez ou modifiez une action, vous devez aller dans le navigateur et vérifier que tout fonctionne comme prévu en cliquant sur les liens et vérifier les éléments sur la page rendue. En d'autres termes, vous exécutez un scénario correspondant au cas d'utilisation que vous venez de mettre en œuvre.</p>
<p>Comme le processus est manuel, il est fastidieux et source d'erreurs. Chaque fois que vous changez quelque chose dans votre code, vous devez faire défiler tous les scénarios pour vérifier que vous n'avez rien cassé. C'est de la folie. Les tests fonctionnels dans Symfony fournissent un moyen facile de décrire des scénarios. Chaque scénario peut alors être automatiquement lu maintes et maintes fois en simulant l'expérience d'un utilisateur dans un navigateur. Comme les tests unitaires, ils vous donnent l'assurance nécessaire pour coder en paix.</p>
<p>Les tests fonctionnels ont un flux de travail très spécifique:</p>
<ul class="unstyled">
	<li>- Faire une demande;</li>
	<li>- Tester la réponse;</li>
	<li>- Cliquer sur un lien ou remplir un formulaire;</li>
	<li>- Tester la réponse;</li>
	<li>- Nettoyer et répéter.</li>
</ul>
<br>
<h2>Notre premier test fonctionnel</h2>
<p>Les tests fonctionnels sont de simples fichiers PHP qui habituellement se situent dans le répertoire <strong>Tests/Controller</strong> de votre paquet. Si vous voulez tester les pages traitées par votre classe <strong>CategoryController</strong>, commencez par créer un fichier <strong>CategoryControllerTest.php</strong> qui étend une classe spéciale <strong>WebTestCase</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Tests/Controller/CategoryControllerTest.php</span></li><li class="L1"><span class="kwd">namespace</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Tests\Controller</span><span class="pun">;</span></li><li class="L2"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Symfony</span><span class="pln">\Bundle\FrameworkBundle\Test\WebTestCase</span><span class="pun">;</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="kwd">class</span><span class="pln"> </span><span class="typ">CategoryControllerTest</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">WebTestCase</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> testShow</span><span class="pun">()</span></li><li class="L7"><span class="pln">  </span><span class="pun">{</span></li><li class="L8"><span class="pln">    $client </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createClient</span><span class="pun">();</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">    $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/category/index'</span><span class="pun">);</span></li><li class="L1"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'Ens\JobeetBundle\Controller\CategoryController::showAction'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'_controller'</span><span class="pun">));</span></li><li class="L2"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="lit">200</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getResponse</span><span class="pun">()-&gt;</span><span class="pln">getStatusCode</span><span class="pun">());</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li></ol></pre>
<br>
<h2>Exécution des tests fonctionnels</h2>
<p>Comme pour les tests unitaires, le lancement des tests fonctionnels peut être fait en exécutant la commande phpunit:</p>
<pre>phpunit -c app/ src/Ens/JobeetBundle/Tests/Controller/CategoryControllerTest</pre>
<p>Ce test va échouer parce que l'URL testée, <strong>/category/index</strong>, n'est pas une URL valide dans Jobeet:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="typ">PHPUnit</span><span class="pln"> </span><span class="lit">3.6</span><span class="pun">.</span><span class="lit">10</span><span class="pln"> </span><span class="kwd">by</span><span class="pln"> </span><span class="typ">Sebastian</span><span class="pln"> </span><span class="typ">Bergmann</span><span class="pun">.</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="typ">Configuration</span><span class="pln"> read </span><span class="kwd">from</span><span class="pln"> </span><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">dragos</span><span class="pun">/</span><span class="pln">work</span><span class="pun">/</span><span class="pln">jobeet</span><span class="pun">/</span><span class="pln">app</span><span class="pun">/</span><span class="pln">phpunit</span><span class="pun">.</span><span class="pln">xml</span><span class="pun">.</span><span class="pln">dist</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">F</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="typ">Time</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2</span><span class="pln"> seconds</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Memory</span><span class="pun">:</span><span class="pln"> </span><span class="lit">14.25Mb</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="typ">There</span><span class="pln"> was </span><span class="lit">1</span><span class="pln"> failure</span><span class="pun">:</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Tests\Controller\CategoryControllerTest</span><span class="pun">::</span><span class="pln">testShow</span></li><li class="L1"><span class="typ">Failed</span><span class="pln"> asserting that </span><span class="kwd">false</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">.</span></li></ol></pre>
<br>
<h2>Écriture des tests fonctionnels</h2>
<p>Écrire des tests fonctionnels, c'est comme jouer un scénario dans un navigateur. Nous avons déjà écrit tous les scénarios que nous avons besoin de tester dans le cadre du <a href="le-projet">deuxième chapitre</a>.</p>
<p>Tout d'abord, nous allons tester la page d'accueil Jobeet en modifiant le fichier de test <strong>JobControllerTest.php</strong>. Remplacez le code par le suivant:</p>
<h5>LES OFFRES EXPIRÉES NE SONT PAS LISTÉES</h5>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Test/Controller/JobControllerTest.php</span></li><li class="L1"><span class="kwd">namespace</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Tests\Controller</span><span class="pun">;</span></li><li class="L2"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Symfony</span><span class="pln">\Bundle\FrameworkBundle\Test\WebTestCase</span><span class="pun">;</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="kwd">class</span><span class="pln"> </span><span class="typ">JobControllerTest</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">WebTestCase</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> testIndex</span><span class="pun">()</span></li><li class="L7"><span class="pln">  </span><span class="pun">{</span></li><li class="L8"><span class="pln">    $client </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createClient</span><span class="pun">();</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">    $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">);</span></li><li class="L1"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'Ens\JobeetBundle\Controller\JobController::indexAction'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'_controller'</span><span class="pun">));</span></li><li class="L2"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.jobs td.position:contains("Expired")'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li></ol></pre>
<p>Pour vérifier l'exclusion des offres expirées depuis la page d'accueil, nous vérifions que le sélecteur CSS <strong>.jobs td.position:contains("Expired")</strong> ne correspond à rien dans le contenu de la réponse HTML (rappelons que dans les fixtures, la seule offre expirée contient "Expired" dans l'intitulé).</p>
<h5>SEULEMENT N OFFRES SONT AFFICHÉES POUR UNE CATÉGORIE</h5>
<p>Ajoutez le code suivant à la fin du fichier de test. Pour obtenir le paramètre personnalisé défini dans <strong>app/config/config.yml</strong> dans notre test fonctionnel, nous allons utiliser le noyau:</p>
<pre class="prettyprint linenums">
    // src/Ens/JobeetBundle/Test/Controller/JobControllerTest.php
    // ...
    $kernel = static::createKernel();
    $kernel->boot();
    $max_jobs_on_homepage = $kernel->getContainer()->getParameter('max_jobs_on_homepage');
    $this->assertTrue($crawler->filter('.category_programming tr')->count() <= $max_jobs_on_homepage);
    // ...
</pre>
<p>Pour que ce test fonctionne, nous aurons besoin d'ajouter la classe CSS correspondant à chaque catégorie dans le fichier <strong>Job/index.html.twig</strong> (afin que nous puissions sélectionner chaque catégorie et compter les offres répertoriées):</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">&lt;!-- src/Ens/JobeetBundle/Resources/views/Job/index.html.twig --&gt;</span></li><li class="L1"><span class="com">&lt;!-- ... --&gt;</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">{% for category in categories %}</span></li><li class="L4"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"category_{{ category.slug }}"</span><span class="tag">&gt;</span></li><li class="L5"><span class="com">&lt;!-- ... --&gt;</span></li></ol></pre>
<h5>UNE CATÉGORIE A UN LIEN VERS LA PAGE CATÉGORIE SEULEMENT S'IL Y A TROP D'OFFRES</h5>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Test/Controller/JobControllerTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.category_design .more_jobs'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L4"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.category_programming .more_jobs'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L5"><span class="com">// ...</span></li></ol></pre>
<p>Dans ces tests, nous vérifions qu'il n'y a pas de "plus d'offres" pour la catégorie Design (<strong>.category_design .more_jobs</strong> n'existe pas), et qu'il y a un "plus d'offres" pour la catégorie Programming (<strong>.category_programming .more_jobs</strong> existe ).</p>
<h5>LES OFFRES SONT TRIÉES PAR DATE</h5>
<p>Pour tester si les offres sont effectivement triées par date, nous devons vérifier que le premier emploi figurant sur la page d'accueil est celui que nous attendons. Cela peut être fait en vérifiant que l'URL contient la clé primaire attendue. Comme la clé primaire peut changer entre les exécutions, nous avons besoin de l'objet Doctrine de la BDD en premier.</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Test/Controller/JobControllerTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">$kernel </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createKernel</span><span class="pun">();</span></li><li class="L4"><span class="pln">$kernel</span><span class="pun">-&gt;</span><span class="pln">boot</span><span class="pun">();</span></li><li class="L5"><span class="pln">$em </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'doctrine.orm.entity_manager'</span><span class="pun">);</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">$query </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">createQuery</span><span class="pun">(</span><span class="str">'SELECT j from EnsJobeetBundle:Job j LEFT JOIN j.category c WHERE c.slug = :slug AND j.expires_at &gt; :date ORDER BY j.expires_at DESC'</span><span class="pun">);</span></li><li class="L8"><span class="pln">$query</span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'slug'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'programming'</span><span class="pun">);</span></li><li class="L9"><span class="pln">$query</span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()));</span></li><li class="L0"><span class="pln">$query</span><span class="pun">-&gt;</span><span class="pln">setMaxResults</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L1"><span class="pln">$job </span><span class="pun">=</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getSingleResult</span><span class="pun">();</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.category_programming tr'</span><span class="pun">)-&gt;</span><span class="pln">first</span><span class="pun">()-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">sprintf</span><span class="pun">(</span><span class="str">'a[href*="/%d/"]'</span><span class="pun">,</span><span class="pln"> $job</span><span class="pun">-&gt;</span><span class="pln">getId</span><span class="pun">()))-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L4"><span class="com">// ...</span></li></ol></pre>
<p>Même si le test fonctionne tel quel, nous avons besoin de factoriser le code un peu, car l'obtention de la première offre de la catégorie Programming peut être réutilisée ailleurs dans nos tests. Nous ne bougerons pas le code vers la couche Modèle puisque le code est spécifique au test. Au lieu de cela, nous allons déplacer le code de la fonction <strong>getMostRecentProgrammingJob()</strong> dans notre classe de test:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Test/Controller/JobControllerTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getMostRecentProgrammingJob</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $kernel </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createKernel</span><span class="pun">();</span></li><li class="L6"><span class="pln">  $kernel</span><span class="pun">-&gt;</span><span class="pln">boot</span><span class="pun">();</span></li><li class="L7"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'doctrine.orm.entity_manager'</span><span class="pun">);</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">  $query </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">createQuery</span><span class="pun">(</span><span class="str">'SELECT j from EnsJobeetBundle:Job j LEFT JOIN j.category c WHERE c.slug = :slug AND j.expires_at &gt; :date ORDER BY j.expires_at DESC'</span><span class="pun">);</span></li><li class="L0"><span class="pln">  $query</span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'slug'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'programming'</span><span class="pun">);</span></li><li class="L1"><span class="pln">  $query</span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()));</span></li><li class="L2"><span class="pln">  $query</span><span class="pun">-&gt;</span><span class="pln">setMaxResults</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getSingleResult</span><span class="pun">();</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="com">// ...</span></li></ol></pre>
<p>Vous pouvez maintenant remplacer le code de test précédent par le suivant:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Test/Controller/JobControllerTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.category_programming tr'</span><span class="pun">)-&gt;</span><span class="pln">first</span><span class="pun">()-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">sprintf</span><span class="pun">(</span><span class="str">'a[href*="/%d/"]'</span><span class="pun">,</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getMostRecentProgrammingJob</span><span class="pun">()-&gt;</span><span class="pln">getId</span><span class="pun">()))-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L4"><span class="com">// ...</span></li></ol></pre>
<h5>CHAQUE OFFRE SUR LA PAGE D'ACCUEIL EST CLIQUABLE</h5>
<p>Pour tester le lien d'offre sur le site, nous simulons un clic sur le texte "Web Developer". Comme il y a beaucoup d'entre eux sur la page, nous avons explicitement demandé au navigateur de cliquer sur la première.</p>
<p>Chaque paramètre de requête est ensuite testé pour s'assurer que le routage a fait son travail correctement.</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Test/Controller/JobControllerTest.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">$job </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getMostRecentProgrammingJob</span><span class="pun">();</span></li><li class="L4"><span class="pln">$link </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectLink</span><span class="pun">(</span><span class="str">'Web Developer'</span><span class="pun">)-&gt;</span><span class="pln">first</span><span class="pun">()-&gt;</span><span class="pln">link</span><span class="pun">();</span></li><li class="L5"><span class="pln">$crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">click</span><span class="pun">(</span><span class="pln">$link</span><span class="pun">);</span></li><li class="L6"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'Ens\JobeetBundle\Controller\JobController::showAction'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'_controller'</span><span class="pun">));</span></li><li class="L7"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">$job</span><span class="pun">-&gt;</span><span class="pln">getCompanySlug</span><span class="pun">(),</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'company'</span><span class="pun">));</span></li><li class="L8"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">$job</span><span class="pun">-&gt;</span><span class="pln">getLocationSlug</span><span class="pun">(),</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'location'</span><span class="pun">));</span></li><li class="L9"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">$job</span><span class="pun">-&gt;</span><span class="pln">getPositionSlug</span><span class="pun">(),</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'position'</span><span class="pun">));</span></li><li class="L0"><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">$job</span><span class="pun">-&gt;</span><span class="pln">getId</span><span class="pun">(),</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'id'</span><span class="pun">));</span></li><li class="L1"><span class="com">// ...</span></li></ol></pre>
<h5>APPRENEZ PAR L'EXEMPLE</h5>
<p>Dans cette section, vous avez tout le code nécessaire pour tester les pages offre et catégorie. Lisez le code avec soin car vous apprendrez quelques nouveaux trucs:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Test/Controller/JobControllerTest.php</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="kwd">namespace</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Tests\Controller</span><span class="pun">;</span></li><li class="L3"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Symfony</span><span class="pln">\Bundle\FrameworkBundle\Test\WebTestCase</span><span class="pun">;</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="kwd">class</span><span class="pln"> </span><span class="typ">JobControllerTest</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">WebTestCase</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getMostRecentProgrammingJob</span><span class="pun">()</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    $kernel </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createKernel</span><span class="pun">();</span></li><li class="L0"><span class="pln">    $kernel</span><span class="pun">-&gt;</span><span class="pln">boot</span><span class="pun">();</span></li><li class="L1"><span class="pln">    $em </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'doctrine.orm.entity_manager'</span><span class="pun">);</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">    $query </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">createQuery</span><span class="pun">(</span><span class="str">'SELECT j from EnsJobeetBundle:Job j LEFT JOIN j.category c WHERE c.slug = :slug AND j.expires_at &gt; :date ORDER BY j.expires_at DESC'</span><span class="pun">);</span></li><li class="L4"><span class="pln">    $query</span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'slug'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'programming'</span><span class="pun">);</span></li><li class="L5"><span class="pln">    $query</span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()));</span></li><li class="L6"><span class="pln">    $query</span><span class="pun">-&gt;</span><span class="pln">setMaxResults</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L7"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getSingleResult</span><span class="pun">();</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getExpiredJob</span><span class="pun">()</span></li><li class="L1"><span class="pln">  </span><span class="pun">{</span></li><li class="L2"><span class="pln">    $kernel </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createKernel</span><span class="pun">();</span></li><li class="L3"><span class="pln">    $kernel</span><span class="pun">-&gt;</span><span class="pln">boot</span><span class="pun">();</span></li><li class="L4"><span class="pln">    $em </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'doctrine.orm.entity_manager'</span><span class="pun">);</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln">    $query </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">createQuery</span><span class="pun">(</span><span class="str">'SELECT j from EnsJobeetBundle:Job j WHERE j.expires_at &lt; :date'</span><span class="pun">);</span><span class="pln">     $query</span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()));</span></li><li class="L7"><span class="pln">    $query</span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()));</span></li><li class="L8"><span class="pln">    $query</span><span class="pun">-&gt;</span><span class="pln">setMaxResults</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getSingleResult</span><span class="pun">();</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> testIndex</span><span class="pun">()</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="com">// get the custom parameters from app config.yml</span></li><li class="L5"><span class="pln">    $kernel </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createKernel</span><span class="pun">();</span></li><li class="L6"><span class="pln">    $kernel</span><span class="pun">-&gt;</span><span class="pln">boot</span><span class="pun">();</span></li><li class="L7"><span class="pln">    $max_jobs_on_homepage </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">'max_jobs_on_homepage'</span><span class="pun">);</span></li><li class="L8"><span class="pln">    $max_jobs_on_category </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">'max_jobs_on_category'</span><span class="pun">);</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">    $client </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createClient</span><span class="pun">();</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">    $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">);</span></li><li class="L3"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'Ens\JobeetBundle\Controller\JobController::indexAction'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'_controller'</span><span class="pun">));</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">    </span><span class="com">// expired jobs are not listed</span></li><li class="L6"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.jobs td.position:contains("Expired")'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln">    </span><span class="com">// only $max_jobs_on_homepage jobs are listed for a category</span></li><li class="L9"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.category_programming tr'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">10</span><span class="pun">);</span></li><li class="L0"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.category_design .more_jobs'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L1"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.category_programming .more_jobs'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">    </span><span class="com">// jobs are sorted by date</span></li><li class="L4"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.category_programming tr'</span><span class="pun">)-&gt;</span><span class="pln">first</span><span class="pun">()-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">sprintf</span><span class="pun">(</span><span class="str">'a[href*="/%d/"]'</span><span class="pun">,</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getMostRecentProgrammingJob</span><span class="pun">()-&gt;</span><span class="pln">getId</span><span class="pun">()))-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln">    </span><span class="com">// each job on the homepage is clickable and give detailed information</span></li><li class="L7"><span class="pln">    $job </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getMostRecentProgrammingJob</span><span class="pun">();</span></li><li class="L8"><span class="pln">    $link </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectLink</span><span class="pun">(</span><span class="str">'Web Developer'</span><span class="pun">)-&gt;</span><span class="pln">first</span><span class="pun">()-&gt;</span><span class="pln">link</span><span class="pun">();</span></li><li class="L9"><span class="pln">    $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">click</span><span class="pun">(</span><span class="pln">$link</span><span class="pun">);</span></li><li class="L0"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'Ens\JobeetBundle\Controller\JobController::showAction'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'_controller'</span><span class="pun">));</span></li><li class="L1"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">$job</span><span class="pun">-&gt;</span><span class="pln">getCompanySlug</span><span class="pun">(),</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'company'</span><span class="pun">));</span></li><li class="L2"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">$job</span><span class="pun">-&gt;</span><span class="pln">getLocationSlug</span><span class="pun">(),</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'location'</span><span class="pun">));</span></li><li class="L3"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">$job</span><span class="pun">-&gt;</span><span class="pln">getPositionSlug</span><span class="pun">(),</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'position'</span><span class="pun">));</span></li><li class="L4"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="pln">$job</span><span class="pun">-&gt;</span><span class="pln">getId</span><span class="pun">(),</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'id'</span><span class="pun">));</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln">    </span><span class="com">// a non-existent job forwards the user to a 404</span></li><li class="L7"><span class="pln">    $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/job/foo-inc/milano-italy/0/painter'</span><span class="pun">);</span></li><li class="L8"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="lit">404</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getResponse</span><span class="pun">()-&gt;</span><span class="pln">getStatusCode</span><span class="pun">());</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">    </span><span class="com">// an expired job page forwards the user to a 404</span></li><li class="L1"><span class="pln">    $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> sprintf</span><span class="pun">(</span><span class="str">'/job/sensio-labs/paris-france/%d/web-developer-expired'</span><span class="pun">,</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getExpiredJob</span><span class="pun">()-&gt;</span><span class="pln">getId</span><span class="pun">()));</span></li><li class="L2"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="lit">404</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getResponse</span><span class="pun">()-&gt;</span><span class="pln">getStatusCode</span><span class="pun">());</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li></ol></pre>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Test/Controller/CategoryControllerTest.php</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="kwd">namespace</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Tests\Controller</span><span class="pun">;</span></li><li class="L3"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Symfony</span><span class="pln">\Bundle\FrameworkBundle\Test\WebTestCase</span><span class="pun">;</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="kwd">class</span><span class="pln"> </span><span class="typ">CategoryControllerTest</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">WebTestCase</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> testShow</span><span class="pun">()</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="com">// get the custom parameters from app config.yml</span></li><li class="L0"><span class="pln">    $kernel </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createKernel</span><span class="pun">();</span></li><li class="L1"><span class="pln">    $kernel</span><span class="pun">-&gt;</span><span class="pln">boot</span><span class="pun">();</span></li><li class="L2"><span class="pln">    $max_jobs_on_homepage </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">'max_jobs_on_homepage'</span><span class="pun">);</span></li><li class="L3"><span class="pln">    $max_jobs_on_category </span><span class="pun">=</span><span class="pln"> $kernel</span><span class="pun">-&gt;</span><span class="pln">getContainer</span><span class="pun">()-&gt;</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">'max_jobs_on_category'</span><span class="pun">);</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">    $client </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">static</span><span class="pun">::</span><span class="pln">createClient</span><span class="pun">();</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">    </span><span class="com">// categories on homepage are clickable</span></li><li class="L8"><span class="pln">    $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">);</span></li><li class="L9"><span class="pln">    $link </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectLink</span><span class="pun">(</span><span class="str">'Programming'</span><span class="pun">)-&gt;</span><span class="pln">link</span><span class="pun">();</span></li><li class="L0"><span class="pln">    $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">click</span><span class="pun">(</span><span class="pln">$link</span><span class="pun">);</span></li><li class="L1"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'Ens\JobeetBundle\Controller\CategoryController::showAction'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'_controller'</span><span class="pun">));</span></li><li class="L2"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'programming'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'slug'</span><span class="pun">));</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">    </span><span class="com">// categories with more than $max_jobs_on_homepage jobs also have a "more" link</span></li><li class="L5"><span class="pln">    $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">);</span></li><li class="L6"><span class="pln">    $link </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectLink</span><span class="pun">(</span><span class="str">'22'</span><span class="pun">)-&gt;</span><span class="pln">link</span><span class="pun">();</span></li><li class="L7"><span class="pln">    $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">click</span><span class="pun">(</span><span class="pln">$link</span><span class="pun">);</span></li><li class="L8"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'Ens\JobeetBundle\Controller\CategoryController::showAction'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'_controller'</span><span class="pun">));</span></li><li class="L9"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="str">'programming'</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'slug'</span><span class="pun">));</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="pln">    </span><span class="com">// only $max_jobs_on_category jobs are listed</span></li><li class="L2"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertTrue</span><span class="pun">(</span><span class="pln">$crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.jobs tr'</span><span class="pun">)-&gt;</span><span class="pln">count</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">20</span><span class="pun">);</span></li><li class="L3"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertRegExp</span><span class="pun">(</span><span class="str">'/32 jobs/'</span><span class="pun">,</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.pagination_desc'</span><span class="pun">)-&gt;</span><span class="pln">text</span><span class="pun">());</span></li><li class="L4"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertRegExp</span><span class="pun">(</span><span class="str">'/page 1\/2/'</span><span class="pun">,</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.pagination_desc'</span><span class="pun">)-&gt;</span><span class="pln">text</span><span class="pun">());</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln">    $link </span><span class="pun">=</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">selectLink</span><span class="pun">(</span><span class="str">'2'</span><span class="pun">)-&gt;</span><span class="pln">link</span><span class="pun">();</span></li><li class="L7"><span class="pln">    $crawler </span><span class="pun">=</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">click</span><span class="pun">(</span><span class="pln">$link</span><span class="pun">);</span></li><li class="L8"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertEquals</span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> $client</span><span class="pun">-&gt;</span><span class="pln">getRequest</span><span class="pun">()-&gt;</span><span class="pln">attributes</span><span class="pun">-&gt;</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'page'</span><span class="pun">));</span></li><li class="L9"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">assertRegExp</span><span class="pun">(</span><span class="str">'/page 2\/2/'</span><span class="pun">,</span><span class="pln"> $crawler</span><span class="pun">-&gt;</span><span class="pln">filter</span><span class="pun">(</span><span class="str">'.pagination_desc'</span><span class="pun">)-&gt;</span><span class="pln">text</span><span class="pun">());</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pun">}</span></li></ol></pre>
<br>
<p class="clearfix noprint">
	<a href="les-tests-unitaires" class="btn btn-success pull-left">Chapitre précédent</a>
	<a href="les-formulaires" class="btn btn-success pull-right">Chapitre suivant</a>
</p>														<p class="link_source noprint"><a href="http://www.ens.ro/2012/04/25/symfony2-jobeet-day-9-the-functional-tests/" target="_blank">» Lire l'article original</a></p>
																					<br>