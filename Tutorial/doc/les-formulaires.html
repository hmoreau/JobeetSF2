<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Tuto Jobeet Symfony2 FR :: Tutoriel Jobeet avec Symfony2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" type="text/css" href="assets/css/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="assets/css/bootstrap-responsive.css" />
<link rel="stylesheet" type="text/css" href="assets/css/style.css" />
<link rel="stylesheet" type="text/css" href="assets/css/docs.css" />
<link rel="stylesheet" type="text/css" href="assets/css/prettify.css" />
<link rel="stylesheet" type="text/css" href="assets/css/shadowbox.css" />
<link rel="stylesheet" type="text/css" href="assets/css/print.css" media="print" />
<link rel="shortcut icon" href="assets/img/favicon.ico">
<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
</head>

<body>
	<a href="https://github.com/thujohn/Jobeet" target="_blank" id="gogithub"><img src="assets/img/github.gif" alt="" /></a>
	<div class="navbar navbar-inverse hide-on-desktop show-on-tablets show-on-mobile noprint">
		<div class="navbar-inner noprint">
			<div class="container">
				<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="brand" href="./">Jobeet FR</a>
				<div class="nav-collapse collapse">
					<ul class="nav">
						<li class="sommaire"><a href="sommaire.html"><i class="icon-chevron-right"></i>Sommaire</a></li><li class="demarrage-du-projet"><a href="demarrage-du-projet.html"><i class="icon-chevron-right"></i><strong>[01]</strong> Démarrage du projet</a></li><li class="le-projet"><a href="le-projet.html"><i class="icon-chevron-right"></i><strong>[02]</strong> Le projet</a></li><li class="le-modele-de-donnees"><a href="le-modele-de-donnees.html"><i class="icon-chevron-right"></i><strong>[03]</strong> Le Modèle de Données</a></li><li class="le-controleur-et-la-vue"><a href="le-controleur-et-la-vue.html"><i class="icon-chevron-right"></i><strong>[04]</strong> Le Contrôleur et la Vue</a></li><li class="le-routage"><a href="le-routage.html"><i class="icon-chevron-right"></i><strong>[05]</strong> Le Routage</a></li><li class="aller-plus-loin-avec-le-modele"><a href="aller-plus-loin-avec-le-modele.html"><i class="icon-chevron-right"></i><strong>[06]</strong> Aller plus loin avec le Modèle</a></li><li class="jouons-avec-la-page-categorie"><a href="jouons-avec-la-page-categorie.html"><i class="icon-chevron-right"></i><strong>[07]</strong> Jouons avec les catégories</a></li><li class="les-tests-unitaires"><a href="les-tests-unitaires.html"><i class="icon-chevron-right"></i><strong>[08]</strong> Les tests unitaires</a></li><li class="les-tests-fonctionnels"><a href="les-tests-fonctionnels.html"><i class="icon-chevron-right"></i><strong>[09]</strong> Les tests fonctionnels</a></li><li class="active"><a href="les-formulaires.html"><i class="icon-chevron-right"></i><strong>[10]</strong> Les formulaires</a></li><li class="testez-vos-formulaires"><a href="testez-vos-formulaires.html"><i class="icon-chevron-right"></i><strong>[11]</strong> Testez vos formulaires</a></li><li class="le-paquet-admin"><a href="le-paquet-admin.html"><i class="icon-chevron-right"></i><strong>[12]</strong> Le paquet Admin</a></li><li class="securite"><a href="securite.html"><i class="icon-chevron-right"></i><strong>[13]</strong> Sécurité</a></li><li class="flux-de-donnees"><a href="flux-de-donnees.html"><i class="icon-chevron-right"></i><strong>[14]</strong> Flux de données</a></li><li class="services-web"><a href="services-web.html"><i class="icon-chevron-right"></i><strong>[15]</strong> Services Web</a></li><li class="l-envoi-d-email"><a href="l-envoi-d-email.html"><i class="icon-chevron-right"></i><strong>[16]</strong> L'envoi d'email</a></li><li class="la-recherche"><a href="la-recherche.html"><i class="icon-chevron-right"></i><strong>[17]</strong> La recherche</a></li><li class="ajax"><a href="ajax.html"><i class="icon-chevron-right"></i><strong>[18]</strong> AJAX</a></li><li class="internationalisation-et-regionalisation"><a href="internationalisation-et-regionalisation.html"><i class="icon-chevron-right"></i><strong>[19]</strong> Internationalisation et régionalisation</a></li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	<div id="container">
		<div id="bootstrap-docs">
			<header class="jumbotron subhead hide-on-tablets hide-on-mobile" id="overview">
				<div class="container">
					<h1><a href="./">Jobeet FR</a></h1>
					<p class="lead">Le tutoriel pour Symfony2 en français</p>
				</div>
			</header>
			<div class="container">
				<div class="row">
										<div class="span3 bs-docs-sidebar hide-on-tablets hide-on-mobile noprint">
						<ul class="nav nav-list bs-docs-sidenav">
							<li class="sommaire"><a href="sommaire.html"><i class="icon-chevron-right"></i>Sommaire</a></li><li class="demarrage-du-projet"><a href="demarrage-du-projet.html"><i class="icon-chevron-right"></i><strong>[01]</strong> Démarrage du projet</a></li><li class="le-projet"><a href="le-projet.html"><i class="icon-chevron-right"></i><strong>[02]</strong> Le projet</a></li><li class="le-modele-de-donnees"><a href="le-modele-de-donnees.html"><i class="icon-chevron-right"></i><strong>[03]</strong> Le Modèle de Données</a></li><li class="le-controleur-et-la-vue"><a href="le-controleur-et-la-vue.html"><i class="icon-chevron-right"></i><strong>[04]</strong> Le Contrôleur et la Vue</a></li><li class="le-routage"><a href="le-routage.html"><i class="icon-chevron-right"></i><strong>[05]</strong> Le Routage</a></li><li class="aller-plus-loin-avec-le-modele"><a href="aller-plus-loin-avec-le-modele.html"><i class="icon-chevron-right"></i><strong>[06]</strong> Aller plus loin avec le Modèle</a></li><li class="jouons-avec-la-page-categorie"><a href="jouons-avec-la-page-categorie.html"><i class="icon-chevron-right"></i><strong>[07]</strong> Jouons avec les catégories</a></li><li class="les-tests-unitaires"><a href="les-tests-unitaires.html"><i class="icon-chevron-right"></i><strong>[08]</strong> Les tests unitaires</a></li><li class="les-tests-fonctionnels"><a href="les-tests-fonctionnels.html"><i class="icon-chevron-right"></i><strong>[09]</strong> Les tests fonctionnels</a></li><li class="active"><a href="les-formulaires.html"><i class="icon-chevron-right"></i><strong>[10]</strong> Les formulaires</a></li><li class="testez-vos-formulaires"><a href="testez-vos-formulaires.html"><i class="icon-chevron-right"></i><strong>[11]</strong> Testez vos formulaires</a></li><li class="le-paquet-admin"><a href="le-paquet-admin.html"><i class="icon-chevron-right"></i><strong>[12]</strong> Le paquet Admin</a></li><li class="securite"><a href="securite.html"><i class="icon-chevron-right"></i><strong>[13]</strong> Sécurité</a></li><li class="flux-de-donnees"><a href="flux-de-donnees.html"><i class="icon-chevron-right"></i><strong>[14]</strong> Flux de données</a></li><li class="services-web"><a href="services-web.html"><i class="icon-chevron-right"></i><strong>[15]</strong> Services Web</a></li><li class="l-envoi-d-email"><a href="l-envoi-d-email.html"><i class="icon-chevron-right"></i><strong>[16]</strong> L'envoi d'email</a></li><li class="la-recherche"><a href="la-recherche.html"><i class="icon-chevron-right"></i><strong>[17]</strong> La recherche</a></li><li class="ajax"><a href="ajax.html"><i class="icon-chevron-right"></i><strong>[18]</strong> AJAX</a></li><li class="internationalisation-et-regionalisation"><a href="internationalisation-et-regionalisation.html"><i class="icon-chevron-right"></i><strong>[19]</strong> Internationalisation et régionalisation</a></li>
						</ul>
					</div>
					<div class="span9">
                        <section class="justify">
                        <a href="les-formulaires-full.html" class="pull-right btn btn-success hide-on-tablets hide-on-mobile noprint">Pleine page</a><div class="page-header clearfix"><h1 class="pull-left">Les formulaires</h1></div>
							<p>Tout site web a des formulaires, du simple formulaire de contact à celui avec beaucoup de champs. L'écriture de formulaire est également l'une des tâches les plus complexes et fastidieuses pour un développeur web: vous devez écrire le formulaire HTML, les règles de validation pour chaque champ, traiter les valeurs pour les stocker dans une BDD, afficher des messages d'erreur, repeupler les champs en cas d'erreurs, et bien plus encore...</p>
<p>Dans le troisième chapitre de ce tutoriel, nous avons utilisé la commande <strong>doctrine:generate:crud</strong> pour générer un simple contrôleur CRUD pour l'entité <strong>Job</strong>. Cela a également engendré un formulaire d'offre que vous pouvez trouver dans le fichier <strong>/src/Ens/JobeetBundle/Form/JobType.php</strong>.</p>
<br>
<h2>Personnaliser le formulaire d'offre</h2>
<p>Le formulaire d'offre est un parfait exemple pour apprendre la personnalisation des formulaires. Voyons comment le personnaliser, étape par étape.</p>
<p>Tout d'abord, changer le "Post a Job" dans la mise en page pour être en mesure de vérifier les modifications directement dans votre navigateur:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">&lt;!-- src/Ens/JobeetBundle/Resources/views/layout.html.twig --&gt;</span></li><li class="L1"><span class="tag">&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"{{ path('ens_job_new') }}"</span><span class="tag">&gt;</span><span class="pln">Post a Job</span><span class="tag">&lt;/a&gt;</span></li></ol></pre>
<p>Puis, modifiez les paramètres de la route <strong>ens_job_show</strong> dans <strong>CreateAction</strong> de <strong>JobController</strong> pour correspondre à la nouvelle route que nous avons créé dans le <a href="le-routage.html">cinquième chapitre</a> de ce tutoriel:</p>
<pre class="prettyprint linenums">
// src/Ens/JobeetBundle/Controller/JobController.php
// ...
 
    public function createAction(Request $request)
    {
        $entity  = new Job();
        $form = $this->createForm(new JobType(), $entity);
        $form->bind($request);

        if ($form->isValid()) {
            $em = $this->getDoctrine()->getManager();
            $em->persist($entity);
            $em->flush();

            return $this->redirect($this->generateUrl('ens_job_show', array(
                'company' => $entity->getCompanySlug(),
                'location' => $entity->getLocationSlug(),
                'id' => $entity->getId(),
                'position' => $entity->getPositionSlug()
              )));
        }

        return $this->render('EnsJobeetBundle:Job:new.html.twig', array(
            'entity' => $entity,
            'form'   => $form->createView(),
        ));
    }
</pre>
<p>Par défaut, le formulaire généré par Doctrine affiche des champs pour toutes les colonnes de la table. Mais pour le formulaire d'offre, certains d'entre eux ne doivent pas être modifiables par l'utilisateur final. Modifiez le formulaire <strong>Job</strong> comme ci-dessous:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Form/JobType.php</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="kwd">namespace</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Form</span><span class="pun">;</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Symfony</span><span class="pln">\Component\Form\AbstractType</span><span class="pun">;</span></li><li class="L5"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Symfony</span><span class="pln">\Component\Form\FormBuilder</span><span class="pun">;</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="kwd">class</span><span class="pln"> </span><span class="typ">JobType</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">AbstractType</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> buildForm</span><span class="pun">(</span><span class="typ">FormBuilder</span><span class="pln"> $builder</span><span class="pun">,</span><span class="pln"> array $options</span><span class="pun">)</span></li><li class="L0"><span class="pln">    </span><span class="pun">{</span></li><li class="L1"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'category'</span><span class="pun">);</span></li><li class="L2"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'type'</span><span class="pun">);</span></li><li class="L3"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'company'</span><span class="pun">);</span></li><li class="L4"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'logo'</span><span class="pun">);</span></li><li class="L5"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'url'</span><span class="pun">);</span></li><li class="L6"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'position'</span><span class="pun">);</span></li><li class="L7"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'location'</span><span class="pun">);</span></li><li class="L8"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'description'</span><span class="pun">);</span></li><li class="L9"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'how_to_apply'</span><span class="pun">);</span></li><li class="L0"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'token'</span><span class="pun">);</span></li><li class="L1"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'is_public'</span><span class="pun">);</span></li><li class="L2"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'email'</span><span class="pun">);</span></li><li class="L3"><span class="pln">    </span><span class="pun">}</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getName</span><span class="pun">()</span></li><li class="L6"><span class="pln">    </span><span class="pun">{</span></li><li class="L7"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'ens_jobeetbundle_jobtype'</span><span class="pun">;</span></li><li class="L8"><span class="pln">    </span><span class="pun">}</span></li><li class="L9"><span class="pun">}</span></li></ol></pre>
<p>La configuration du formulaire doit parfois être plus précise que l'introspection à partir du schéma de la BDD. Par exemple, la colonne <strong>email</strong> est un <strong>varchar</strong> dans le schéma, mais nous avons besoin de cette colonne pour être validé comme un email. Dans Symfony2, la validation est appliquée à l'objet sous-jacent (par exemple <strong>Job</strong>). En d'autres termes, la question n'est pas de savoir si le "formulaire" est valide, mais si oui ou non l'objet <strong>Job</strong> est valide après que le formulaire ait appliqué les données qui lui sont soumises. Pour ce faire, créez un nouveau fichier <strong>validation.yml</strong> dans le répertoire <strong>Resources/config</strong> de notre paquet:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># src/Ens/JobeetBundle/Resources/config/validation.yml</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">Ens\JobeetBundle\Entity\</span><span class="kwd">Job:</span></li><li class="L3"><span class="pln">    </span><span class="kwd">properties:</span></li><li class="L4"><span class="pln">    </span><span class="kwd">email:</span></li><li class="L5"><span class="pln">        </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li><li class="L6"><span class="pln">        </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">Email: </span><span class="pln">~</span></li></ol></pre>
<p>Même si la colonne <strong>type</strong> est également un <strong>varchar</strong> dans le schéma, nous voulons que sa valeur soit limitée à une liste de choix: temps plein, temps partiel, ou freelance.</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Form/JobType.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Entity\Job</span><span class="pun">;</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="kwd">class</span><span class="pln"> </span><span class="typ">JobType</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">AbstractType</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> buildForm</span><span class="pun">(</span><span class="typ">FormBuilder</span><span class="pln"> $builder</span><span class="pun">,</span><span class="pln"> array $options</span><span class="pun">)</span></li><li class="L8"><span class="pln">    </span><span class="pun">{</span></li><li class="L9"><span class="pln">        </span><span class="com">// ...</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="pln">        $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'type'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'choice'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="str">'choices'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="typ">Job</span><span class="pun">::</span><span class="pln">getTypes</span><span class="pun">(),</span><span class="pln"> </span><span class="str">'expanded'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">));</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">        </span><span class="com">// ...</span></li><li class="L4"><span class="pln">    </span><span class="pun">}</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln">    </span><span class="com">// ...</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pun">}</span></li></ol></pre>
<p>Pour que cela fonctionne, ajoutez les méthodes suivantes en respectant l'entité <strong>Job</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Entity/Job.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getTypes</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> array</span><span class="pun">(</span><span class="str">'full-time'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Full time'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'part-time'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Part time'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'freelance'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Freelance'</span><span class="pun">);</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getTypeValues</span><span class="pun">()</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> array_keys</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">::</span><span class="pln">getTypes</span><span class="pun">());</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="com">// ...</span></li></ol></pre>
<p>La méthode <strong>GetTypes</strong> est utilisée dans le formulaire pour obtenir les types possibles pour une offre d'emploi et <strong>getTypeValues</strong> sera utilisée dans la validation pour obtenir les valeurs valides pour le champ <strong>Type</strong>.</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># src/Ens/JobeetBundle/Resources/config/validation.yml</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">Ens\JobeetBundle\Entity\</span><span class="kwd">Job:</span></li><li class="L3"><span class="pln">    </span><span class="kwd">properties:</span></li><li class="L4"><span class="pln">        </span><span class="kwd">type:</span></li><li class="L5"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li><li class="L6"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">Choice: </span><span class="pln">{ </span><span class="kwd">callback: </span><span class="pln">getTypeValues }</span></li><li class="L7"><span class="pln">        </span><span class="kwd">email:</span></li><li class="L8"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li><li class="L9"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">Email: </span><span class="pln">~</span></li></ol></pre>
<p>Pour chaque champ, Symfony génère automatiquement un label (qui sera utilisé dans la balise &lt;label&gt; rendue). Ceci peut être changé avec l'option label:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="pln">$builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'logo'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="str">'label'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Company logo'</span><span class="pun">));</span></li><li class="L1"><span class="pln">$builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'how_to_apply'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="str">'label'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'How to apply?'</span><span class="pun">));</span></li><li class="L2"><span class="pln">$builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'is_public'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="str">'label'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Public?'</span><span class="pun">));</span></li></ol></pre>
<p>Vous devez également ajouter des contraintes de validation pour le reste des champs:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># src/Ens/JobeetBundle/Resources/config/validation.yml</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">Ens\JobeetBundle\Entity\</span><span class="kwd">Job:</span></li><li class="L3"><span class="pln">    </span><span class="kwd">properties:</span></li><li class="L4"><span class="pln">        </span><span class="kwd">category:</span></li><li class="L5"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li><li class="L6"><span class="pln">        </span><span class="kwd">type:</span></li><li class="L7"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li><li class="L8"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">Choice: </span><span class="pln">{</span><span class="kwd">callback: </span><span class="pln">getTypeValues}</span></li><li class="L9"><span class="pln">        </span><span class="kwd">company:</span></li><li class="L0"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li><li class="L1"><span class="pln">        </span><span class="kwd">position:</span></li><li class="L2"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li><li class="L3"><span class="pln">        </span><span class="kwd">location:</span></li><li class="L4"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li><li class="L5"><span class="pln">        </span><span class="kwd">description:</span></li><li class="L6"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li><li class="L7"><span class="pln">        </span><span class="kwd">how_to_apply:</span></li><li class="L8"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li><li class="L9"><span class="pln">        </span><span class="kwd">token:</span></li><li class="L0"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li><li class="L1"><span class="pln">        </span><span class="kwd">email:</span></li><li class="L2"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li><li class="L3"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">Email: </span><span class="pln">~</span></li></ol></pre>
<br>
<h2>Gestion des uploads de fichiers dans Symfony2</h2>
<p>Pour gérer le fichier uploadé dans le formulaire, nous allons utiliser un champ <strong>file</strong> "virtuel". Pour cela, nous allons ajouter une nouvelle propriété file à l'entité <strong>Job</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Entity/Job.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> $file</span><span class="pun">;</span></li></ol></pre>
<p>Maintenant nous avons besoin de remplacer le logo avec le widget file et le modifier en un input de type file:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Form/JobType.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">$builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'file'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'file'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="str">'label'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Company logo'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'required'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">));</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="com">// ...</span></li></ol></pre>
<p>Pour vous assurer que le fichier uploadé est une image valide, nous allons utiliser la contrainte de validation <strong>Image</strong>:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># src/Ens/JobeetBundle/Resources/config/validation.yml</span></li><li class="L1"><span class="pln">Ens\JobeetBundle\Entity\</span><span class="kwd">Job:</span></li><li class="L2"><span class="pln">    </span><span class="kwd">properties:</span></li><li class="L3"><span class="pln">        </span><span class="com"># ...</span></li><li class="L4"><span class="pln">        </span><span class="kwd">file:</span></li><li class="L5"><span class="pln">            </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">Image: </span><span class="pln">~</span></li></ol></pre>
<p>Lorsque le formulaire est soumis, le champ <strong>file</strong> sera une instance de <a href="http://api.symfony.com/2.0/Symfony/Component/HttpFoundation/File/UploadedFile.html" target="_blank">UploadedFile</a>. Il peut être utilisé pour déplacer le fichier vers un emplacement permanent. Après cela, nous allons définir la propriété <strong>logo</strong> au nom du fichier uploadé.</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeedBundle/Controller/JobController.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> createAction</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="com">// ...</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$form</span><span class="pun">-&gt;</span><span class="pln">isValid</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">    $em </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getDoctrine</span><span class="pun">()-&gt;</span><span class="pln">getEntityManager</span><span class="pun">();</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">    $entity</span><span class="pun">-&gt;</span><span class="pln">file</span><span class="pun">-&gt;</span><span class="pln">move</span><span class="pun">(</span><span class="pln">__DIR__</span><span class="pun">.</span><span class="str">'/../../../../web/uploads/jobs'</span><span class="pun">,</span><span class="pln"> $entity</span><span class="pun">-&gt;</span><span class="pln">file</span><span class="pun">-&gt;</span><span class="pln">getClientOriginalName</span><span class="pun">());</span></li><li class="L1"><span class="pln">    $entity</span><span class="pun">-&gt;</span><span class="pln">setLogo</span><span class="pun">(</span><span class="pln">$entity</span><span class="pun">-&gt;</span><span class="pln">file</span><span class="pun">-&gt;</span><span class="pln">getClientOriginalName</span><span class="pun">());</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">    $em</span><span class="pun">-&gt;</span><span class="pln">persist</span><span class="pun">(</span><span class="pln">$entity</span><span class="pun">);</span></li><li class="L4"><span class="pln">    $em</span><span class="pun">-&gt;</span><span class="pln">flush</span><span class="pun">();</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">redirect</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">generateUrl</span><span class="pun">(</span><span class="str">'ens_job_show'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span></li><li class="L7"><span class="pln">      </span><span class="str">'company'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $entity</span><span class="pun">-&gt;</span><span class="pln">getCompanySlug</span><span class="pun">(),</span></li><li class="L8"><span class="pln">      </span><span class="str">'location'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $entity</span><span class="pun">-&gt;</span><span class="pln">getLocationSlug</span><span class="pun">(),</span></li><li class="L9"><span class="pln">      </span><span class="str">'id'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $entity</span><span class="pun">-&gt;</span><span class="pln">getId</span><span class="pun">(),</span></li><li class="L0"><span class="pln">      </span><span class="str">'position'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $entity</span><span class="pun">-&gt;</span><span class="pln">getPositionSlug</span><span class="pun">()</span></li><li class="L1"><span class="pln">    </span><span class="pun">)));</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln">  </span><span class="com">// ...</span></li><li class="L4"><span class="pun">}</span></li></ol></pre>
<blockquote><p><em>Vous devez créer le répertoire logo (<strong>web/uploads/jobs/</strong>) et vérifier qu'il est accessible en écriture par le serveur web.</em></p></blockquote>
<p>Même si cette implémentation fonctionne, la meilleure façon est de gérer l'upload de fichiers à l'aide de l'entité Doctrine <strong>Job</strong>.</p>
<p>Tout d'abord, ajoutez la ligne suivante à l'entité <strong>Job</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getUploadDir</span><span class="pun">()</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="str">'uploads/jobs'</span><span class="pun">;</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getUploadRootDir</span><span class="pun">()</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> __DIR__</span><span class="pun">.</span><span class="str">'/../../../../web/'</span><span class="pun">.</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">getUploadDir</span><span class="pun">();</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getWebPath</span><span class="pun">()</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">null</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">logo </span><span class="pun">?</span><span class="pln"> </span><span class="kwd">null</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getUploadDir</span><span class="pun">().</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">logo</span><span class="pun">;</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getAbsolutePath</span><span class="pun">()</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">null</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">logo </span><span class="pun">?</span><span class="pln"> </span><span class="kwd">null</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getUploadRootDir</span><span class="pun">().</span><span class="str">'/'</span><span class="pun">.</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">logo</span><span class="pun">;</span></li><li class="L8"><span class="pun">}</span></li></ol></pre>
<p>La propriété <strong>logo</strong> enregistre le chemin relatif au fichier et est conservé dans la BDD. <strong>getAbsolutePath()</strong> est une méthode pratique qui renvoie le chemin absolu vers le fichier alors que <strong>getWebPath()</strong> est une méthode qui renvoie le chemin web, qui peut être utilisé dans un template pour créer un lien vers le fichier uploadé.</p>
<p>Nous ferons la mise en œuvre de telle sorte que l'opération de la BDD et le déplacement du fichier soient atomiques: si il y a un problème persistant de l'entité ou si le fichier ne peut pas être enregistré, rien ne se passera. Pour ce faire, nous avons besoin de déplacer le fichier de telle sort que Doctrine persiste l'objet dans la BDD. Ceci peut être accompli par hooking dans le <strong>lifecycleCallbacks</strong> de l'entité <strong>Job</strong>. Comme nous l'avons fait dans le <a href="le-modele-de-donnees.html">troisième chapitre</a> du tutoriel Jobeet, nous allons modifier le fichier <strong>Job.orm.yml</strong> et y ajouter les <strong>lifecycleCallbacks</strong> <strong>preUpload</strong>, <strong>upload</strong> et <strong>removeUpload</strong>:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># src/Ens/JobeetBundle/Resources/config/doctrine/Job.orm.yml</span></li><li class="L1"><span class="pln">Ens\JobeetBundle\Entity\</span><span class="kwd">Job:</span></li><li class="L2"><span class="com"># ...</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">  </span><span class="kwd">lifecycleCallbacks:</span></li><li class="L5"><span class="pln">    </span><span class="kwd">prePersist: </span><span class="pln">[ preUpload, setCreatedAtValue, setExpiresAtValue ]</span></li><li class="L6"><span class="pln">    </span><span class="kwd">preUpdate: </span><span class="pln">[ preUpload, setUpdatedAtValue ]</span></li><li class="L7"><span class="pln">    </span><span class="kwd">postPersist: </span><span class="pln">[ upload ]</span></li><li class="L8"><span class="pln">    </span><span class="kwd">postUpdate: </span><span class="pln">[ upload ]</span></li><li class="L9"><span class="pln">    </span><span class="kwd">postRemove: </span><span class="pln">[ removeUpload ]</span></li></ol></pre>
<p>Maintenant, exécutez la commande Doctrine <strong>generate:entities</strong> pour ajouter ces nouvelles méthodes à l'entité <strong>Job</strong>:</p>
<pre>php app/console doctrine:generate:entities EnsJobeetBundle</pre>
<p>Modifiez l'entité <strong>Job</strong> et modifiez les méthodes ajoutées à ce qui suit:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Entity/Job.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="com">/**</span></li><li class="L4"><span class="com">* @ORM\prePersist</span></li><li class="L5"><span class="com">*/</span></li><li class="L6"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> preUpload</span><span class="pun">()</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">null</span><span class="pln"> </span><span class="pun">!==</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">file</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="com">// do whatever you want to generate a unique name</span></li><li class="L0"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">logo </span><span class="pun">=</span><span class="pln"> uniqid</span><span class="pun">().</span><span class="str">'.'</span><span class="pun">.</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">file</span><span class="pun">-&gt;</span><span class="pln">guessExtension</span><span class="pun">();</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="com">/**</span></li><li class="L5"><span class="com">* @ORM\postPersist</span></li><li class="L6"><span class="com">*/</span></li><li class="L7"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> upload</span><span class="pun">()</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">null</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">file</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">  </span><span class="com">// if there is an error when moving the file, an exception will</span></li><li class="L4"><span class="pln">  </span><span class="com">// be automatically thrown by move(). This will properly prevent</span></li><li class="L5"><span class="pln">  </span><span class="com">// the entity from being persisted to the database on error</span></li><li class="L6"><span class="pln">  $this</span><span class="pun">-&gt;</span><span class="pln">file</span><span class="pun">-&gt;</span><span class="pln">move</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">getUploadRootDir</span><span class="pun">(),</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">logo</span><span class="pun">);</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln">  unset</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">file</span><span class="pun">);</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="com">/**</span></li><li class="L2"><span class="com">* @ORM\postRemove</span></li><li class="L3"><span class="com">*/</span></li><li class="L4"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> removeUpload</span><span class="pun">()</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$file </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getAbsolutePath</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">    unlink</span><span class="pun">(</span><span class="pln">$file</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="com">// ...</span></li></ol></pre>
<p>La classe fait maintenant tout ce qu'il faut: elle génère un nom de fichier unique avant la persistance, déplace le fichier après la persistance, et supprime le fichier si l'entité est déjà supprimée. Maintenant que le déplacement du fichier est géré atomiquement par l'entité, il faut supprimer le code que nous avons ajouté plus tôt dans le contrôleur pour gérer l'upload:</p>
<pre class="prettyprint linenums">
// src/Ens/JobeetBundle/Controller/JobController.php
// ...
 
public function createAction()
{
  $entity  = new Job();
  $request = $this->getRequest();
  $form    = $this->createForm(new JobType(), $entity);
  $form->bind($request);
 
  if ($form->isValid()) {
    $em = $this->getDoctrine()->getEntityManager();
 
    $em->persist($entity);
    $em->flush();
 
    return $this->redirect($this->generateUrl('ens_job_show', array(
      'company' => $entity->getCompanySlug(),
      'location' => $entity->getLocationSlug(),
      'id' => $entity->getId(),
      'position' => $entity->getPositionSlug()
    )));
  }
 
  return $this->render('EnsJobeetBundle:Job:new.html.twig', array(
    'entity' => $entity,
    'form'   => $form->createView()
  ));
}
 
// ...
</pre>
<br>
<h2>Le template du formulaire</h2>
<p>Maintenant que la classe du formulaire a été personnalisée, nous avons besoin de l'afficher. Ouvrez le template <strong>new.html.twig</strong> et modifiez-le:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">&lt;!-- /src/Ens/JobeetBundle/Resources/views/Job/new.html.twig --&gt;</span></li><li class="L1"><span class="pln">{% extends 'EnsJobeetBundle::layout.html.twig' %}</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">{% form_theme form _self %}</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">{% block field_errors %}</span></li><li class="L6"><span class="pln">{% spaceless %}</span></li><li class="L7"><span class="pln">  {% if errors|length &gt; 0 %}</span></li><li class="L8"><span class="pln">    </span><span class="tag">&lt;ul</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"error_list"</span><span class="tag">&gt;</span></li><li class="L9"><span class="pln">      {% for error in errors %}</span></li><li class="L0"><span class="pln">        </span><span class="tag">&lt;li&gt;</span><span class="pln">{{ error.messageTemplate|trans(error.messageParameters, 'validators') }}</span><span class="tag">&lt;/li&gt;</span></li><li class="L1"><span class="pln">      {% endfor %}</span></li><li class="L2"><span class="pln">    </span><span class="tag">&lt;/ul&gt;</span></li><li class="L3"><span class="pln">  {% endif %}</span></li><li class="L4"><span class="pln">{% endspaceless %}</span></li><li class="L5"><span class="pln">{% endblock field_errors %}</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">{% block stylesheets %}</span></li><li class="L8"><span class="pln">  {{ parent() }}</span></li><li class="L9"><span class="pln">  </span><span class="tag">&lt;link</span><span class="pln"> </span><span class="atn">rel</span><span class="pun">=</span><span class="atv">"stylesheet"</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"{{ asset('bundles/ensjobeet/css/job.css') }}"</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/css"</span><span class="pln"> </span><span class="atn">media</span><span class="pun">=</span><span class="atv">"all"</span><span class="pln"> </span><span class="tag">/&gt;</span></li><li class="L0"><span class="pln">{% endblock %}</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">{% block content %}</span></li><li class="L3"><span class="pln">  </span><span class="tag">&lt;h1&gt;</span><span class="pln">Job creation</span><span class="tag">&lt;/h1&gt;</span></li><li class="L4"><span class="pln">  </span><span class="tag">&lt;form</span><span class="pln"> </span><span class="atn">action</span><span class="pun">=</span><span class="atv">"{{ path('ens_job_create') }}"</span><span class="pln"> </span><span class="atn">method</span><span class="pun">=</span><span class="atv">"post"</span><span class="pln"> {{ </span><span class="atn">form_enctype</span><span class="pln">(</span><span class="atn">form</span><span class="pln">) }}</span><span class="tag">&gt;</span></li><li class="L5"><span class="pln">    </span><span class="tag">&lt;table</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"job_form"</span><span class="tag">&gt;</span></li><li class="L6"><span class="pln">      </span><span class="tag">&lt;tfoot&gt;</span></li><li class="L7"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L8"><span class="pln">          </span><span class="tag">&lt;td</span><span class="pln"> </span><span class="atn">colspan</span><span class="pun">=</span><span class="atv">"2"</span><span class="tag">&gt;</span></li><li class="L9"><span class="pln">            </span><span class="tag">&lt;input</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"submit"</span><span class="pln"> </span><span class="atn">value</span><span class="pun">=</span><span class="atv">"Preview your job"</span><span class="pln"> </span><span class="tag">/&gt;</span></li><li class="L0"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L1"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L2"><span class="pln">      </span><span class="tag">&lt;/tfoot&gt;</span></li><li class="L3"><span class="pln">      </span><span class="tag">&lt;tbody&gt;</span></li><li class="L4"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L5"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.category) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L6"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L7"><span class="pln">            {{ form_errors(form.category) }}</span></li><li class="L8"><span class="pln">            {{ form_widget(form.category) }}</span></li><li class="L9"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L0"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L1"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L2"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.type) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L3"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L4"><span class="pln">            {{ form_errors(form.type) }}</span></li><li class="L5"><span class="pln">            {{ form_widget(form.type) }}</span></li><li class="L6"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L7"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L8"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L9"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.company) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L0"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L1"><span class="pln">            {{ form_errors(form.company) }}</span></li><li class="L2"><span class="pln">            {{ form_widget(form.company) }}</span></li><li class="L3"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L4"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L5"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L6"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.file) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L7"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L8"><span class="pln">            {{ form_errors(form.file) }}</span></li><li class="L9"><span class="pln">            {{ form_widget(form.file) }}</span></li><li class="L0"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L1"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L2"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L3"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.url) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L4"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L5"><span class="pln">            {{ form_errors(form.url) }}</span></li><li class="L6"><span class="pln">            {{ form_widget(form.url) }}</span></li><li class="L7"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L8"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L9"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L0"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.position) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L1"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L2"><span class="pln">            {{ form_errors(form.position) }}</span></li><li class="L3"><span class="pln">            {{ form_widget(form.position) }}</span></li><li class="L4"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L5"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L6"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L7"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.location) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L8"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L9"><span class="pln">            {{ form_errors(form.location) }}</span></li><li class="L0"><span class="pln">            {{ form_widget(form.location) }}</span></li><li class="L1"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L2"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L3"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L4"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.description) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L5"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L6"><span class="pln">            {{ form_errors(form.description) }}</span></li><li class="L7"><span class="pln">            {{ form_widget(form.description) }}</span></li><li class="L8"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L9"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L0"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L1"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.how_to_apply) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L2"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L3"><span class="pln">            {{ form_errors(form.how_to_apply) }}</span></li><li class="L4"><span class="pln">            {{ form_widget(form.how_to_apply) }}</span></li><li class="L5"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L6"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L7"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L8"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.token) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L9"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L0"><span class="pln">            {{ form_errors(form.token) }}</span></li><li class="L1"><span class="pln">            {{ form_widget(form.token) }}</span></li><li class="L2"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L3"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L4"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L5"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.is_public) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L6"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L7"><span class="pln">            {{ form_errors(form.is_public) }}</span></li><li class="L8"><span class="pln">            {{ form_widget(form.is_public) }}</span></li><li class="L9"><span class="pln">            </span><span class="tag">&lt;br</span><span class="pln"> </span><span class="tag">/&gt;</span><span class="pln"> Whether the job can also be published on affiliate websites or not.</span></li><li class="L0"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L1"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L2"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L3"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.email) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L4"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L5"><span class="pln">            {{ form_errors(form.email) }}</span></li><li class="L6"><span class="pln">            {{ form_widget(form.email) }}</span></li><li class="L7"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L8"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L9"><span class="pln">      </span><span class="tag">&lt;/tbody&gt;</span></li><li class="L0"><span class="pln">    </span><span class="tag">&lt;/table&gt;</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">    {{ form_rest(form) }}</span></li><li class="L3"><span class="pln">  </span><span class="tag">&lt;/form&gt;</span></li><li class="L4"><span class="pln">{% endblock %}</span></li></ol></pre>
<p>Nous pourrions afficher le formulaire en utilisant simplement la ligne de code suivante, mais comme nous avons besoin de plus de personnalisation, nous avons choisi d'afficher chaque champ de formulaire à la main.</p>
<pre>{{ form_widget(form) }}</pre>
<p>En appelant <strong>form_widget(form)</strong>, chaque champ du formulaire est affiché, accompagné d'un message d'erreur et d'un label (s'il en existe un). Aussi facile que cela soit, ce n'est pas très souple. Habituellement, vous aurez envie de rendre chaque champ de formulaire individuellement, de sorte de pouvoir contrôler la façon dont le formulaire ressemble.</p>
<p>Nous avons également utilisé une technique appelée <a href="http://symfony.com/doc/current/book/forms.html#form-theming" target="_blank">Form Theming</a> pour <a href="http://symfony.com/doc/current/cookbook/form/form_customization.html#customizing-error-output" target="_blank">personnaliser la façon dont les erreurs de formulaire seront affichées</a>. Vous pouvez en lire plus à ce sujet dans la documentation officielle de Symfony2.</p>
<p>Faites la même chose avec le template <strong>edit.html.twig</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">&lt;!-- /src/Ens/JobeetBundle/Resources/views/Job/edit.html.twig --&gt;</span></li><li class="L1"><span class="pln">{% extends 'EnsJobeetBundle::layout.html.twig' %}</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">{% form_theme edit_form _self %}</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">{% block field_errors %}</span></li><li class="L6"><span class="pln">{% spaceless %}</span></li><li class="L7"><span class="pln">  {% if errors|length &gt; 0 %}</span></li><li class="L8"><span class="pln">    </span><span class="tag">&lt;ul&gt;</span></li><li class="L9"><span class="pln">      {% for error in errors %}</span></li><li class="L0"><span class="pln">        </span><span class="tag">&lt;li&gt;</span><span class="pln">{{ error.messageTemplate|trans(error.messageParameters, 'validators') }}</span><span class="tag">&lt;/li&gt;</span></li><li class="L1"><span class="pln">      {% endfor %}</span></li><li class="L2"><span class="pln">    </span><span class="tag">&lt;/ul&gt;</span></li><li class="L3"><span class="pln">  {% endif %}</span></li><li class="L4"><span class="pln">{% endspaceless %}</span></li><li class="L5"><span class="pln">{% endblock field_errors %}</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">{% block stylesheets %}</span></li><li class="L8"><span class="pln">  {{ parent() }}</span></li><li class="L9"><span class="pln">  </span><span class="tag">&lt;link</span><span class="pln"> </span><span class="atn">rel</span><span class="pun">=</span><span class="atv">"stylesheet"</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"{{ asset('bundles/ensjobeet/css/job.css') }}"</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text/css"</span><span class="pln"> </span><span class="atn">media</span><span class="pun">=</span><span class="atv">"all"</span><span class="pln"> </span><span class="tag">/&gt;</span></li><li class="L0"><span class="pln">{% endblock %}</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">{% block content %}</span></li><li class="L3"><span class="pln">  </span><span class="tag">&lt;h1&gt;</span><span class="pln">Job edit</span><span class="tag">&lt;/h1&gt;</span></li><li class="L4"><span class="pln">  </span><span class="tag">&lt;form</span><span class="pln"> </span><span class="atn">action</span><span class="pun">=</span><span class="atv">"{{ path('ens_job_update', { 'id': entity.id }) }}"</span><span class="pln"> </span><span class="atn">method</span><span class="pun">=</span><span class="atv">"post"</span><span class="pln"> {{ </span><span class="atn">form_enctype</span><span class="pln">(</span><span class="atn">edit_form</span><span class="pln">) }}</span><span class="tag">&gt;</span></li><li class="L5"><span class="pln">    </span><span class="tag">&lt;table</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"job_form"</span><span class="tag">&gt;</span></li><li class="L6"><span class="pln">      </span><span class="tag">&lt;tfoot&gt;</span></li><li class="L7"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L8"><span class="pln">          </span><span class="tag">&lt;td</span><span class="pln"> </span><span class="atn">colspan</span><span class="pun">=</span><span class="atv">"2"</span><span class="tag">&gt;</span></li><li class="L9"><span class="pln">            </span><span class="tag">&lt;input</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"submit"</span><span class="pln"> </span><span class="atn">value</span><span class="pun">=</span><span class="atv">"Preview your job"</span><span class="pln"> </span><span class="tag">/&gt;</span></li><li class="L0"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L1"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L2"><span class="pln">      </span><span class="tag">&lt;/tfoot&gt;</span></li><li class="L3"><span class="pln">      </span><span class="tag">&lt;tbody&gt;</span></li><li class="L4"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L5"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.category) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L6"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L7"><span class="pln">            {{ form_errors(edit_form.category) }}</span></li><li class="L8"><span class="pln">            {{ form_widget(edit_form.category) }}</span></li><li class="L9"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L0"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L1"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L2"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.type) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L3"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L4"><span class="pln">            {{ form_errors(edit_form.type) }}</span></li><li class="L5"><span class="pln">            {{ form_widget(edit_form.type) }}</span></li><li class="L6"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L7"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L8"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L9"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.company) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L0"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L1"><span class="pln">            {{ form_errors(edit_form.company) }}</span></li><li class="L2"><span class="pln">            {{ form_widget(edit_form.company) }}</span></li><li class="L3"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L4"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L5"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L6"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.file) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L7"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L8"><span class="pln">            {{ form_errors(edit_form.file) }}</span></li><li class="L9"><span class="pln">            {{ form_widget(edit_form.file) }}</span></li><li class="L0"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L1"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L2"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L3"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.url) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L4"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L5"><span class="pln">            {{ form_errors(edit_form.url) }}</span></li><li class="L6"><span class="pln">            {{ form_widget(edit_form.url) }}</span></li><li class="L7"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L8"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L9"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L0"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.position) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L1"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L2"><span class="pln">            {{ form_errors(edit_form.position) }}</span></li><li class="L3"><span class="pln">            {{ form_widget(edit_form.position) }}</span></li><li class="L4"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L5"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L6"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L7"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.location) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L8"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L9"><span class="pln">            {{ form_errors(edit_form.location) }}</span></li><li class="L0"><span class="pln">            {{ form_widget(edit_form.location) }}</span></li><li class="L1"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L2"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L3"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L4"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.description) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L5"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L6"><span class="pln">            {{ form_errors(edit_form.description) }}</span></li><li class="L7"><span class="pln">            {{ form_widget(edit_form.description) }}</span></li><li class="L8"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L9"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L0"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L1"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.how_to_apply) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L2"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L3"><span class="pln">            {{ form_errors(edit_form.how_to_apply) }}</span></li><li class="L4"><span class="pln">            {{ form_widget(edit_form.how_to_apply) }}</span></li><li class="L5"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L6"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L7"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L8"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.token) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L9"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L0"><span class="pln">            {{ form_errors(edit_form.token) }}</span></li><li class="L1"><span class="pln">            {{ form_widget(edit_form.token) }}</span></li><li class="L2"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L3"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L4"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L5"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.is_public) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L6"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L7"><span class="pln">            {{ form_errors(edit_form.is_public) }}</span></li><li class="L8"><span class="pln">            {{ form_widget(edit_form.is_public) }}</span></li><li class="L9"><span class="pln">            </span><span class="tag">&lt;br</span><span class="pln"> </span><span class="tag">/&gt;</span><span class="pln"> Whether the job can also be published on affiliate websites or not.</span></li><li class="L0"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L1"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L2"><span class="pln">        </span><span class="tag">&lt;tr&gt;</span></li><li class="L3"><span class="pln">          </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.email) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L4"><span class="pln">          </span><span class="tag">&lt;td&gt;</span></li><li class="L5"><span class="pln">            {{ form_errors(edit_form.email) }}</span></li><li class="L6"><span class="pln">            {{ form_widget(edit_form.email) }}</span></li><li class="L7"><span class="pln">          </span><span class="tag">&lt;/td&gt;</span></li><li class="L8"><span class="pln">        </span><span class="tag">&lt;/tr&gt;</span></li><li class="L9"><span class="pln">      </span><span class="tag">&lt;/tbody&gt;</span></li><li class="L0"><span class="pln">    </span><span class="tag">&lt;/table&gt;</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">    {{ form_rest(edit_form) }}</span></li><li class="L3"><span class="pln">  </span><span class="tag">&lt;/form&gt;</span></li><li class="L4"><span class="pln">{% endblock %}</span></li></ol></pre>
<br>
<h2>Les actions du formulaire</h2>
<p>Nous avons maintenant une classe de formulaire et un template qui l'affiche. Maintenant, il est temps de le faire réellement fonctionner avec certaines actions. Le formulaire d'offre est géré par quatre méthodes dans <strong>JobController</strong>:</p>
<ul class="unstyled">
	<li>- <strong>newAction</strong>: Affiche un formulaire vierge pour créer une nouvelle offre</li>
	<li>- <strong>createAction</strong>: Traite le formulaire (validation, repopulation du formulaire), et crée une nouvelle offre avec les valeurs soumises par l'utilisateur</li>
	<li>- <strong>editAction</strong>: Affiche un formulaire pour modifier une offre existante</li>
	<li>- <strong>updateAction</strong>: Traite le formulaire (validation, repopulation du formulaire), et met à jour une offre avec les valeurs soumises par l'utilisateur</li>
</ul>
<p>Lorsque vous accédez à la page <strong>/job/new</strong>, une instance du formulaire pour un nouvel objet <strong>Job</strong> est créée en appelant la méthode <strong>createForm</strong> et transmise au template (<strong>newAction</strong>).</p>
<p>Lorsque l'utilisateur soumet le formulaire (<strong>createAction</strong>), le formulaire est lié (méthode <strong>bind()</strong>) aux valeurs soumises par l'utilisateur et la validation est déclenchée.</p>
<p>Une fois que le formulaire est lié, il est possible de vérifier sa validité en utilisant la méthode <strong>isValid()</strong>:</p>
<ul class="unstyled">
	<li>- Si le formulaire est valide (retourne <strong>true</strong>), l'offre est enregistrée dans la BDD (<strong>$em-&gt;persist($entity)</strong>), et l'utilisateur est redirigé vers la page de prévisualisation de l'offre</li>
	<li>- Sinon, le template <strong>new.html.twig</strong> s'affiche à nouveau avec les valeurs soumises par l'utilisateur et les messages d'erreur associés</li>
</ul>
<p>La modification d'une offre existante est assez similaire. La seule différence entre les actions <strong>new</strong> et <strong>edit</strong> est que l'objet <strong>Job</strong> à modifier est passé en second argument de la méthode <strong>createForm</strong>. Cet objet sera utilisé pour les valeurs par défaut du widget dans le template.</p>
<p>Vous pouvez également définir des valeurs par défaut pour le formulaire de création. Pour cela, nous allons passer un objet <strong>Job</strong> pré-modifié à la méthode <strong>createForm</strong> pour définir la valeur de <strong>type</strong> par défaut à <strong>temps plein</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Controller/JobController.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> newAction</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $entity </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Job</span><span class="pun">();</span></li><li class="L6"><span class="pln">  $entity</span><span class="pun">-&gt;</span><span class="pln">setType</span><span class="pun">(</span><span class="str">'full-time'</span><span class="pun">);</span></li><li class="L7"><span class="pln">  $form   </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createForm</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">JobType</span><span class="pun">(),</span><span class="pln"> $entity</span><span class="pun">);</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">render</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job:new.html.twig'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span></li><li class="L0"><span class="pln">    </span><span class="str">'entity'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $entity</span><span class="pun">,</span></li><li class="L1"><span class="pln">    </span><span class="str">'form'</span><span class="pln">   </span><span class="pun">=&gt;</span><span class="pln"> $form</span><span class="pun">-&gt;</span><span class="pln">createView</span><span class="pun">()</span></li><li class="L2"><span class="pln">  </span><span class="pun">));</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="com">// ...</span></li></ol></pre>
<h5>PROTECTION DU FORMULAIRE D'OFFRE AVEC UN JETON</h5>
<p>Tout doit fonctionner correctement maintenant. Désormais, l'utilisateur doit saisir le jeton pour l'offre. Mais comme nous ne voulons pas compter sur l'utilisateur pour fournir un jeton unique, le jeton de l'offre doit être généré automatiquement quand une nouvelle offre est créée. Créez une nouvelle méthode <strong>setTokenValue()</strong> de l'entité <strong>Job</strong> pour ajouter la logique qui génère le jeton avant qu'une nouvelle offre ne soit enregistrée:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Entity/Job.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> setTokenValue</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pun">(!</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">getToken</span><span class="pun">())</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">token </span><span class="pun">=</span><span class="pln"> sha1</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">getEmail</span><span class="pun">().</span><span class="pln">rand</span><span class="pun">(</span><span class="lit">11111</span><span class="pun">,</span><span class="pln"> </span><span class="lit">99999</span><span class="pun">));</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="com">// ...</span></li></ol></pre>
<p>Ajoutez cette méthode au <strong>lifecycleCallbacks</strong> <strong>PrePersist</strong> pour l'entité <strong>Job</strong>:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># src/End/JobeetBundle/Resources/config/doctrine/Job.orm.yml</span></li><li class="L1"><span class="com"># ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">  </span><span class="kwd">lifecycleCallbacks:</span></li><li class="L4"><span class="pln">    </span><span class="kwd">prePersist: </span><span class="pln">[ setTokenValue, preUpload, setCreatedAtValue, setExpiresAtValue ]</span></li><li class="L5"><span class="pln">    </span><span class="com"># ...</span></li></ol></pre>
<p>Régénérez les entités Doctrine pour appliquer cette modification:</p>
<pre>php app/console doctrine:generate:entities EnsJobeetBundle</pre>
<p>Vous pouvez maintenant supprimer le champ <strong>token</strong> du formulaire:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Form/JobType.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> buildForm</span><span class="pun">(</span><span class="typ">FormBuilder</span><span class="pln"> $builder</span><span class="pun">,</span><span class="pln"> array $options</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">    $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'category'</span><span class="pun">);</span></li><li class="L6"><span class="pln">    $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'type'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'choice'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="str">'choices'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="typ">Job</span><span class="pun">::</span><span class="pln">getTypes</span><span class="pun">(),</span><span class="pln"> </span><span class="str">'expanded'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">));</span></li><li class="L7"><span class="pln">    $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'company'</span><span class="pun">);</span></li><li class="L8"><span class="pln">    $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'file'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'file'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="str">'label'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Company logo'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'required'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">));</span></li><li class="L9"><span class="pln">    $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'url'</span><span class="pun">);</span></li><li class="L0"><span class="pln">    $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'position'</span><span class="pun">);</span></li><li class="L1"><span class="pln">    $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'location'</span><span class="pun">);</span></li><li class="L2"><span class="pln">    $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'description'</span><span class="pun">);</span></li><li class="L3"><span class="pln">    $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'how_to_apply'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="str">'label'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'How to apply?'</span><span class="pun">));</span></li><li class="L4"><span class="pln">    $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'is_public'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span><span class="str">'label'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">'Public?'</span><span class="pun">));</span></li><li class="L5"><span class="pln">    $builder</span><span class="pun">-&gt;</span><span class="pln">add</span><span class="pun">(</span><span class="str">'email'</span><span class="pun">);</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="com">// ...</span></li></ol></pre>
<p>Supprimez-le aussi des templates <strong>new.html.twig</strong> et <strong>edit.html.twig</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">&lt;!-- src/Ens/JobeetBundle/Resources/views/Job/new.html.twig --&gt;</span></li><li class="L1"><span class="tag">&lt;tr&gt;</span></li><li class="L2"><span class="pln">  </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(form.token) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L3"><span class="pln">  </span><span class="tag">&lt;td&gt;</span></li><li class="L4"><span class="pln">    {{ form_errors(form.token) }}</span></li><li class="L5"><span class="pln">    {{ form_widget(form.token) }}</span></li><li class="L6"><span class="pln">  </span><span class="tag">&lt;/td&gt;</span></li><li class="L7"><span class="tag">&lt;/tr&gt;</span></li></ol></pre>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">&lt;!-- src/Ens/JobeetBundle/Resources/views/Job/edit.html.twig --&gt;</span></li><li class="L1"><span class="tag">&lt;tr&gt;</span></li><li class="L2"><span class="pln">  </span><span class="tag">&lt;th&gt;</span><span class="pln">{{ form_label(edit_form.token) }}</span><span class="tag">&lt;/th&gt;</span></li><li class="L3"><span class="pln">  </span><span class="tag">&lt;td&gt;</span></li><li class="L4"><span class="pln">    {{ form_errors(edit_form.token) }}</span></li><li class="L5"><span class="pln">    {{ form_widget(edit_form.token) }}</span></li><li class="L6"><span class="pln">  </span><span class="tag">&lt;/td&gt;</span></li><li class="L7"><span class="tag">&lt;/tr&gt;</span></li></ol></pre>
<p>Et dans le fichier <strong>validation.yml</strong>:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># src/Ens/JobeetBundle/Resources/config/validation.yml</span></li><li class="L1"><span class="com"># ...</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">token:</span></li><li class="L4"><span class="pln">    </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">NotBlank: </span><span class="pln">~</span></li></ol></pre>
<p>Si vous vous souvenez des scénarios du deuxième chapitre, une offre ne peut être modifiée que si l'utilisateur connaît le jeton associé. À l'heure actuelle, il est assez facile de modifier ou de supprimer n'importe quelle offre en essayant de deviner l'URL. C'est parce que l'URL saisie ressemble à <strong>/job/ID/edit</strong>, où ID est la clé primaire de l'offre.</p>
<p>Nous allons changer les routes de sorte que vous puissiez modifier ou supprimer une tâche uniquement si vous connaissez le jeton secret:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># src/End/JobeetBundle/Resources/config/routing/job.yml</span></li><li class="L1"><span class="com"># ...</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">ens_job_edit:</span></li><li class="L4"><span class="pln">    </span><span class="kwd">pattern: </span><span class="pln"> /{token}/edit</span></li><li class="L5"><span class="pln">    </span><span class="kwd">defaults: </span><span class="pln">{ </span><span class="kwd">_controller: </span><span class="str">"EnsJobeetBundle:Job:edit"</span><span class="pln"> }</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="kwd">ens_job_update:</span></li><li class="L8"><span class="pln">    </span><span class="kwd">pattern: </span><span class="pln"> /{token}/update</span></li><li class="L9"><span class="pln">    </span><span class="kwd">defaults: </span><span class="pln">{ </span><span class="kwd">_controller: </span><span class="str">"EnsJobeetBundle:Job:update"</span><span class="pln"> }</span></li><li class="L0"><span class="pln">    </span><span class="kwd">requirements: </span><span class="pln">{ </span><span class="kwd">_method: </span><span class="pln">post }</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="kwd">ens_job_delete:</span></li><li class="L3"><span class="pln">    </span><span class="kwd">pattern: </span><span class="pln"> /{token}/delete</span></li><li class="L4"><span class="pln">    </span><span class="kwd">defaults: </span><span class="pln">{ </span><span class="kwd">_controller: </span><span class="str">"EnsJobeetBundle:Job:delete"</span><span class="pln"> }</span></li><li class="L5"><span class="pln">    </span><span class="kwd">requirements: </span><span class="pln">{ </span><span class="kwd">_method: </span><span class="pln">post }</span></li></ol></pre>
<p>Maintenant, modifiez <strong>JobController</strong> pour utiliser le jeton à la place de l'ID:</p>
<pre class="prettyprint linenums">
// src/Ens/JobeetBundle/Controller/JobController.php
// ...
 
public function editAction($token)
{
  $em = $this->getDoctrine()->getEntityManager();
 
  $entity = $em->getRepository('EnsJobeetBundle:Job')->findOneByToken($token);
 
  if (!$entity) {
    throw $this->createNotFoundException('Unable to find Job entity.');
  }
 
  $editForm = $this->createForm(new JobType(), $entity);
  $deleteForm = $this->createDeleteForm($token);
 
  return $this->render('EnsJobeetBundle:Job:edit.html.twig', array(
    'entity'      => $entity,
    'edit_form'   => $editForm->createView(),
    'delete_form' => $deleteForm->createView(),
  ));
}
 
public function updateAction(Request $request,$token)
{
  $em = $this->getDoctrine()->getEntityManager();
 
  $entity = $em->getRepository('EnsJobeetBundle:Job')->findOneByToken($token);
 
  if (!$entity) {
    throw $this->createNotFoundException('Unable to find Job entity.');
  }
 
  $editForm   = $this->createForm(new JobType(), $entity);
  $deleteForm = $this->createDeleteForm($token);
 
  $request = $this->getRequest();
 
  $editForm->bind($request);
 
  if ($editForm->isValid()) {
    $em->persist($entity);
    $em->flush();
 
    return $this->redirect($this->generateUrl('ens_job_edit', array('token' => $token)));
  }
 
  return $this->render('EnsJobeetBundle:Job:edit.html.twig', array(
    'entity'      => $entity,
    'edit_form'   => $editForm->createView(),
    'delete_form' => $deleteForm->createView(),
  ));
}
 
public function deleteAction(Request $request,$token)
{
  $form = $this->createDeleteForm($token);
  $request = $this->getRequest();
 
  $form->bind($request);
 
  if ($form->isValid()) {
    $em = $this->getDoctrine()->getEntityManager();
    $entity = $em->getRepository('EnsJobeetBundle:Job')->findOneByToken($token);
 
    if (!$entity) {
      throw $this->createNotFoundException('Unable to find Job entity.');
    }
 
    $em->remove($entity);
    $em->flush();
  }
 
  return $this->redirect($this->generateUrl('ens_job'));
}
 
private function createDeleteForm($token)
{
  return $this->createFormBuilder(array('token' => $token))
    ->add('token', 'hidden')
    ->getForm()
  ;
}
</pre>
<p>Dans le template d'offre <strong>show.html.twig</strong>, modifiez le paramètre de route <strong>ens_job_edit</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="tag">&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"{{ path('ens_job_edit', { 'token': entity.token }) }}"</span><span class="tag">&gt;</span></li></ol></pre>
<p>Faites de même pour la route <strong>ens_job_update</strong> dans le template d'offre <strong>edit.html.twig</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="tag">&lt;form</span><span class="pln"> </span><span class="atn">action</span><span class="pun">=</span><span class="atv">"{{ path('ens_job_update', { 'token': entity.token }) }}"</span><span class="pln"> </span><span class="atn">method</span><span class="pun">=</span><span class="atv">"post"</span><span class="pln"> {{ </span><span class="atn">form_enctype</span><span class="pln">(</span><span class="atn">edit_form</span><span class="pln">) }}</span><span class="tag">&gt;</span></li></ol></pre>
<p>Maintenant, toutes les routes liées aux offres, à l'exception de <strong>job_show_user</strong>, incorporent le jeton. Par exemple, la route pour modifier une offre est maintenant sur le schéma suivant:</p>
<pre>http://jobeet.local/job/TOKEN/edit</pre>
<br>
<h2>La page de prévisualisation</h2>
<p>La page de prévisualisation est la même que l'affichage de la page d'offre. La seule différence est que la page de prévisualisation sera accessible à l'aide du jeton de l'offre plutôt que l'ID de l'offre:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># src/End/JobeetBundle/Resources/config/routing/job.yml</span></li><li class="L1"><span class="com"># ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">ens_job_show:</span></li><li class="L4"><span class="pln">    </span><span class="kwd">pattern: </span><span class="pln"> /{company}/{location}/{id}/{position}</span></li><li class="L5"><span class="pln">    </span><span class="kwd">defaults: </span><span class="pln">{ </span><span class="kwd">_controller: </span><span class="str">"EnsJobeetBundle:Job:show"</span><span class="pln"> }</span></li><li class="L6"><span class="pln">    </span><span class="kwd">requirements:</span></li><li class="L7"><span class="pln">        </span><span class="kwd">id: </span><span class="pln"> \d+</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="kwd">ens_job_preview:</span></li><li class="L0"><span class="pln">    </span><span class="kwd">pattern: </span><span class="pln"> /{company}/{location}/{token}/{position}</span></li><li class="L1"><span class="pln">    </span><span class="kwd">defaults: </span><span class="pln">{ </span><span class="kwd">_controller: </span><span class="str">"EnsJobeetBundle:Job:preview"</span><span class="pln"> }</span></li><li class="L2"><span class="pln">    </span><span class="kwd">requirements:</span></li><li class="L3"><span class="pln">        </span><span class="kwd">token: </span><span class="pln"> \w+</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="com"># ...</span></li></ol></pre>
<p>L'action <strong>preview</strong> (ici la différence avec l'action <strong>show</strong>, c'est que l'offre est récupérée à partir de la BDD en utilisant le jeton fourni à la place de l'ID):</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Controller/JobController.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> previewAction</span><span class="pun">(</span><span class="pln">$token</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getDoctrine</span><span class="pun">()-&gt;</span><span class="pln">getEntityManager</span><span class="pun">();</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  $entity </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job'</span><span class="pun">)-&gt;</span><span class="pln">findOneByToken</span><span class="pun">(</span><span class="pln">$token</span><span class="pun">);</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">$entity</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="kwd">throw</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createNotFoundException</span><span class="pun">(</span><span class="str">'Unable to find Job entity.'</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">  $deleteForm </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createDeleteForm</span><span class="pun">(</span><span class="pln">$entity</span><span class="pun">-&gt;</span><span class="pln">getId</span><span class="pun">());</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">render</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job:show.html.twig'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span></li><li class="L6"><span class="pln">    </span><span class="str">'entity'</span><span class="pln">      </span><span class="pun">=&gt;</span><span class="pln"> $entity</span><span class="pun">,</span></li><li class="L7"><span class="pln">    </span><span class="str">'delete_form'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $deleteForm</span><span class="pun">-&gt;</span><span class="pln">createView</span><span class="pun">(),</span></li><li class="L8"><span class="pln">  </span><span class="pun">));</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="com">// ...</span></li></ol></pre>
<p>Si l'utilisateur va à l'URL avec le jeton, nous allons ajouter une barre d'administration dans la partie supérieure. Au début du template <strong>show.html.twig</strong>, incluez un template pour mettre la barre d'administration et supprimez le lien <strong>Modifier</strong> en bas:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">&lt;!-- /src/Ens/JobeetBundle/Resources/views/Job/show.html.twig --&gt;</span></li><li class="L1"><span class="com">&lt;!-- ... --&gt;</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">{% block content %}</span></li><li class="L4"><span class="pln">  {% if app.request.get('token') %}</span></li><li class="L5"><span class="pln">    {% include 'EnsJobeetBundle:Job:admin.html.twig' with {'job': entity} %}</span></li><li class="L6"><span class="pln">  {% endif %}</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln">  </span><span class="com">&lt;!-- ... --&gt;</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">{% endblock %}</span></li></ol></pre>
<p>Ensuite, créez le template <strong>admin.html.twig</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">&lt;!-- /src/Ens/JobeetBundle/Resources/views/Job/admin.html.twig --&gt;</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"job_actions"</span><span class="tag">&gt;</span></li><li class="L3"><span class="pln">  </span><span class="tag">&lt;h3&gt;</span><span class="pln">Admin</span><span class="tag">&lt;/h3&gt;</span></li><li class="L4"><span class="pln">  </span><span class="tag">&lt;ul&gt;</span></li><li class="L5"><span class="pln">    {% if not job.isActivated %}</span></li><li class="L6"><span class="pln">      </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"{{ path('ens_job_edit', { 'token': job.token }) }}"</span><span class="tag">&gt;</span><span class="pln">Edit</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span></li><li class="L7"><span class="pln">      </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"{{ path('ens_job_edit', { 'token': job.token }) }}"</span><span class="tag">&gt;</span><span class="pln">Publish</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span></li><li class="L8"><span class="pln">    {% endif %}</span></li><li class="L9"><span class="pln">    </span><span class="tag">&lt;li&gt;</span></li><li class="L0"><span class="pln">      </span><span class="tag">&lt;form</span><span class="pln"> </span><span class="atn">action</span><span class="pun">=</span><span class="atv">"{{ path('ens_job_delete', { 'token': job.token }) }}"</span><span class="pln"> </span><span class="atn">method</span><span class="pun">=</span><span class="atv">"post"</span><span class="tag">&gt;</span></li><li class="L1"><span class="pln">        {{ form_widget(delete_form) }}</span></li><li class="L2"><span class="pln">        </span><span class="tag">&lt;button</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"submit"</span><span class="pln"> </span><span class="atn">onclick</span><span class="pun">=</span><span class="atv">"</span><span class="kwd">if</span><span class="pun">(!</span><span class="pln">confirm</span><span class="pun">(</span><span class="str">'Are you sure?'</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln"> </span><span class="pun">}</span><span class="atv">"</span><span class="tag">&gt;</span><span class="pln">Delete</span><span class="tag">&lt;/button&gt;</span></li><li class="L3"><span class="pln">      </span><span class="tag">&lt;/form&gt;</span></li><li class="L4"><span class="pln">    </span><span class="tag">&lt;/li&gt;</span></li><li class="L5"><span class="pln">    {% if job.isActivated %}</span></li><li class="L6"><span class="pln">      </span><span class="tag">&lt;li</span><span class="pln"> {% </span><span class="atn">if</span><span class="pln"> </span><span class="atn">job</span><span class="pln">.</span><span class="atn">expiresSoon</span><span class="pln"> %} </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"expires_soon"</span><span class="pln"> {% </span><span class="atn">endif</span><span class="pln"> %}</span><span class="tag">&gt;</span></li><li class="L7"><span class="pln">        {% if job.isExpired %}</span></li><li class="L8"><span class="pln">          Expired</span></li><li class="L9"><span class="pln">        {% else %}</span></li><li class="L0"><span class="pln">          Expires in </span><span class="tag">&lt;strong&gt;</span><span class="pln">{{ job.getDaysBeforeExpires }}</span><span class="tag">&lt;/strong&gt;</span><span class="pln"> days</span></li><li class="L1"><span class="pln">        {% endif %}</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">        {% if job.expiresSoon %}</span></li><li class="L4"><span class="pln">          - </span><span class="tag">&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">""</span><span class="tag">&gt;</span><span class="pln">Extend</span><span class="tag">&lt;/a&gt;</span><span class="pln"> for another 30 days</span></li><li class="L5"><span class="pln">        {% endif %}</span></li><li class="L6"><span class="pln">      </span><span class="tag">&lt;/li&gt;</span></li><li class="L7"><span class="pln">    {% else %}</span></li><li class="L8"><span class="pln">      </span><span class="tag">&lt;li&gt;</span></li><li class="L9"><span class="pln">        [Bookmark this </span><span class="tag">&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"{{ url('ens_job_preview', { 'token': job.token, 'company': job.companyslug, 'location': job.locationslug, 'position': job.positionslug }) }}"</span><span class="tag">&gt;</span><span class="pln">URL</span><span class="tag">&lt;/a&gt;</span><span class="pln"> to manage this job in the future.]</span></li><li class="L0"><span class="pln">      </span><span class="tag">&lt;/li&gt;</span></li><li class="L1"><span class="pln">    {% endif %}</span></li><li class="L2"><span class="pln">  </span><span class="tag">&lt;/ul&gt;</span></li><li class="L3"><span class="tag">&lt;/div&gt;</span></li></ol></pre>
<p>Il y a beaucoup de code, mais la plupart du code est simple à comprendre.</p>
<p>Pour rendre le template plus lisible, nous avons ajouté un ensemble de raccourcis de méthodes dans la classe d'entité <strong>Job</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Entity/Job.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> isExpired</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getDaysBeforeExpires</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> expiresSoon</span><span class="pun">()</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getDaysBeforeExpires</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">5</span><span class="pun">;</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getDaysBeforeExpires</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> ceil</span><span class="pun">((</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">getExpiresAt</span><span class="pun">()-&gt;</span><span class="pln">format</span><span class="pun">(</span><span class="str">'U'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> time</span><span class="pun">())</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="lit">86400</span><span class="pun">);</span></li><li class="L6"><span class="pun">}</span></li></ol></pre>
<p>La barre d'administration affiche les différentes actions en fonction du statut de l'offre:</p>
<p class="tcenter"><a href="assets/img/jobeet_10-1.png" rel="shadowbox"><img src="assets/img/jobeet_10-1.png" alt="" class="img-polaroid"></a></p>
<p class="tcenter"><a href="assets/img/jobeet_10-2.png" rel="shadowbox"><img src="assets/img/jobeet_10-2.png" alt="" class="img-polaroid"></a></p>
<p>Nous allons maintenant rediriger les actions <strong>create</strong> et <strong>update</strong> de <strong>JobController</strong> ver la nouvelle page de prévisualisation: </p>
<pre class="prettyprint linenums">
// src/Ens/JobeetBundle/Controller/JobController.php
// ...
 
public function createAction(Request $request)
{
  // ...
 
  if ($form->isValid()) {
    // ...
 
    return $this->redirect($this->generateUrl('ens_job_preview', array(
      'company' => $entity->getCompanySlug(),
      'location' => $entity->getLocationSlug(),
      'token' => $entity->getToken(),
      'position' => $entity->getPositionSlug()
    )));
  }
 
  // ...
}
 
public function updateAction(Request $request,$token)
{
  // ...
 
  if ($editForm->isValid()) {
    // ...
 
    return $this->redirect($this->generateUrl('ens_job_preview', array(
      'company' => $entity->getCompanySlug(),
      'location' => $entity->getLocationSlug(),
      'token' => $entity->getToken(),
      'position' => $entity->getPositionSlug()
    )));
  }
 
  // ...
}
</pre>
<br>
<h2>Activation et publication des offres</h2>
<p>Dans la section précédente, il y a un lien pour publier l'offre. Le lien doit être modifié pour pointer vers une nouvelle action <strong>publish</strong>. Pour cela, nous allons créer une nouvelle route:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># src/Ens/JobeetBundle/Resources/config/routing/job.yml</span></li><li class="L1"><span class="com"># ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">ens_job_publish:</span></li><li class="L4"><span class="pln">    </span><span class="kwd">pattern: </span><span class="pln"> /{token}/publish</span></li><li class="L5"><span class="pln">    </span><span class="kwd">defaults: </span><span class="pln">{ </span><span class="kwd">_controller: </span><span class="str">"EnsJobeetBundle:Job:publish"</span><span class="pln"> }</span></li><li class="L6"><span class="pln">    </span><span class="kwd">requirements: </span><span class="pln">{ </span><span class="kwd">_method: </span><span class="pln">post }</span></li></ol></pre>
<p>Nous pouvons maintenant modifier le lien "Publish" (nous allons utiliser un formulaire ici, comme lors de la suppression d'une offre, nous aurons donc une requête POST):</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">&lt;!-- src/Ens/JobeetBundle/Resources/views/job/admin.html.twig --&gt;</span></li><li class="L1"><span class="com">&lt;!-- ... --&gt;</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">{% if not job.isActivated %}</span></li><li class="L4"><span class="pln">  </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"{{ path('ens_job_edit', { 'token': job.token }) }}"</span><span class="tag">&gt;</span><span class="pln">Edit</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span></li><li class="L5"><span class="pln">  </span><span class="tag">&lt;li&gt;</span></li><li class="L6"><span class="pln">    </span><span class="tag">&lt;form</span><span class="pln"> </span><span class="atn">action</span><span class="pun">=</span><span class="atv">"{{ path('ens_job_publish', { 'token': job.token }) }}"</span><span class="pln"> </span><span class="atn">method</span><span class="pun">=</span><span class="atv">"post"</span><span class="tag">&gt;</span></li><li class="L7"><span class="pln">      {{ form_widget(publish_form) }}</span></li><li class="L8"><span class="pln">      </span><span class="tag">&lt;button</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"submit"</span><span class="tag">&gt;</span><span class="pln">Publish</span><span class="tag">&lt;/button&gt;</span></li><li class="L9"><span class="pln">    </span><span class="tag">&lt;/form&gt;</span></li><li class="L0"><span class="pln">  </span><span class="tag">&lt;/li&gt;</span></li><li class="L1"><span class="pln">{% endif %}</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="com">&lt;!-- ... --&gt;</span></li></ol></pre>
<p>La dernière étape consiste à créer l'action <strong>publish</strong>, le formulaire <strong>publish</strong> et modifier l'action <strong>preview</strong> pour envoyer le formulaire <strong>publish</strong> vers le template:</p>
<pre class="prettyprint linenums">
// src/Ens/JobeetBundle/Controller/JobController.php
// ...
 
public function previewAction($token)
{
  // ...
 
  $deleteForm = $this->createDeleteForm($entity->getId());
  $publishForm = $this->createPublishForm($entity->getToken());
 
  return $this->render('EnsJobeetBundle:Job:show.html.twig', array(
    'entity'      => $entity,
    'delete_form' => $deleteForm->createView(),
    'publish_form' => $publishForm->createView(),
  ));
}
 
public function publishAction(Request $request,$token)
{
  $form = $this->createPublishForm($token);
  $form->bindRequest($request);
 
  if ($form->isValid()) {
    $em = $this->getDoctrine()->getEntityManager();
    $entity = $em->getRepository('EnsJobeetBundle:Job')->findOneByToken($token);
 
    if (!$entity) {
      throw $this->createNotFoundException('Unable to find Job entity.');
    }
 
    $entity->publish();
    $em->persist($entity);
    $em->flush();
 
    $this->get('session')->setFlash('notice', 'Your job is now online for 30 days.');
  }
 
  return $this->redirect($this->generateUrl('ens_job_preview', array(
    'company' => $entity->getCompanySlug(),
    'location' => $entity->getLocationSlug(),
    'token' => $entity->getToken(),
    'position' => $entity->getPositionSlug()
  )));
}
 
private function createPublishForm($token)
{
  return $this->createFormBuilder(array('token' => $token))
    ->add('token', 'hidden')
    ->getForm()
  ;
}
 
// ...
</pre>
<p>La méthode <strong>publishAction()</strong> utilise une nouvelle méthode <strong>publish()</strong> qui peut être définie comme suit:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Entity/Job.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> publish</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $this</span><span class="pun">-&gt;</span><span class="pln">setIsActivated</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="com">// ...</span></li></ol></pre>
<p>Vous pouvez maintenant tester la nouvelle fonctionnalité de publication dans votre navigateur.</p>
<p>Mais nous avons encore quelque chose à corriger. Les emplois non-activés ne doivent pas être accessibles, ce qui signifie qu'ils ne doivent pas apparaître sur la page d'accueil Jobeet et ne doivent pas être accessibles via leur URL. Nous devons modifier les méthodes de <strong>JobRepository</strong> pour ajouter cette exigence:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src Ens/JobeetBundle/Repository/JobRepository.php</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="kwd">namespace</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Repository</span><span class="pun">;</span></li><li class="L3"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Doctrine</span><span class="pln">\ORM\EntityRepository</span><span class="pun">;</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="kwd">class</span><span class="pln"> </span><span class="typ">JobRepository</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">EntityRepository</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getActiveJobs</span><span class="pun">(</span><span class="pln">$category_id </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> $max </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> $offset </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    $qb </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createQueryBuilder</span><span class="pun">(</span><span class="str">'j'</span><span class="pun">)</span></li><li class="L0"><span class="pln">    </span><span class="pun">-&gt;</span><span class="kwd">where</span><span class="pun">(</span><span class="str">'j.expires_at &gt; :date'</span><span class="pun">)</span></li><li class="L1"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()))</span></li><li class="L2"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">andWhere</span><span class="pun">(</span><span class="str">'j.is_activated = :activated'</span><span class="pun">)</span></li><li class="L3"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'activated'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></li><li class="L4"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">orderBy</span><span class="pun">(</span><span class="str">'j.expires_at'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'DESC'</span><span class="pun">);</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">$max</span><span class="pun">)</span></li><li class="L7"><span class="pln">    </span><span class="pun">{</span></li><li class="L8"><span class="pln">      $qb</span><span class="pun">-&gt;</span><span class="pln">setMaxResults</span><span class="pun">(</span><span class="pln">$max</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="pun">}</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">$offset</span><span class="pun">)</span></li><li class="L2"><span class="pln">    </span><span class="pun">{</span></li><li class="L3"><span class="pln">      $qb</span><span class="pun">-&gt;</span><span class="pln">setFirstResult</span><span class="pun">(</span><span class="pln">$offset</span><span class="pun">);</span></li><li class="L4"><span class="pln">    </span><span class="pun">}</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">$category_id</span><span class="pun">)</span></li><li class="L7"><span class="pln">    </span><span class="pun">{</span></li><li class="L8"><span class="pln">      $qb</span><span class="pun">-&gt;</span><span class="pln">andWhere</span><span class="pun">(</span><span class="str">'j.category = :category_id'</span><span class="pun">)</span></li><li class="L9"><span class="pln">        </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'category_id'</span><span class="pun">,</span><span class="pln"> $category_id</span><span class="pun">);</span></li><li class="L0"><span class="pln">    </span><span class="pun">}</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">    $query </span><span class="pun">=</span><span class="pln"> $qb</span><span class="pun">-&gt;</span><span class="pln">getQuery</span><span class="pun">();</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getResult</span><span class="pun">();</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> countActiveJobs</span><span class="pun">(</span><span class="pln">$category_id </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    $qb </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createQueryBuilder</span><span class="pun">(</span><span class="str">'j'</span><span class="pun">)</span></li><li class="L0"><span class="pln">    </span><span class="pun">-&gt;</span><span class="kwd">select</span><span class="pun">(</span><span class="str">'count(j.id)'</span><span class="pun">)</span></li><li class="L1"><span class="pln">    </span><span class="pun">-&gt;</span><span class="kwd">where</span><span class="pun">(</span><span class="str">'j.expires_at &gt; :date'</span><span class="pun">)</span></li><li class="L2"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()))</span></li><li class="L3"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">andWhere</span><span class="pun">(</span><span class="str">'j.is_activated = :activated'</span><span class="pun">)</span></li><li class="L4"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'activated'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">$category_id</span><span class="pun">)</span></li><li class="L7"><span class="pln">    </span><span class="pun">{</span></li><li class="L8"><span class="pln">      $qb</span><span class="pun">-&gt;</span><span class="pln">andWhere</span><span class="pun">(</span><span class="str">'j.category = :category_id'</span><span class="pun">)</span></li><li class="L9"><span class="pln">        </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'category_id'</span><span class="pun">,</span><span class="pln"> $category_id</span><span class="pun">);</span></li><li class="L0"><span class="pln">    </span><span class="pun">}</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">    $query </span><span class="pun">=</span><span class="pln"> $qb</span><span class="pun">-&gt;</span><span class="pln">getQuery</span><span class="pun">();</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getSingleScalarResult</span><span class="pun">();</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getActiveJob</span><span class="pun">(</span><span class="pln">$id</span><span class="pun">)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    $query </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createQueryBuilder</span><span class="pun">(</span><span class="str">'j'</span><span class="pun">)</span></li><li class="L0"><span class="pln">      </span><span class="pun">-&gt;</span><span class="kwd">where</span><span class="pun">(</span><span class="str">'j.id = :id'</span><span class="pun">)</span></li><li class="L1"><span class="pln">      </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'id'</span><span class="pun">,</span><span class="pln"> $id</span><span class="pun">)</span></li><li class="L2"><span class="pln">      </span><span class="pun">-&gt;</span><span class="pln">andWhere</span><span class="pun">(</span><span class="str">'j.expires_at &gt; :date'</span><span class="pun">)</span></li><li class="L3"><span class="pln">      </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()))</span></li><li class="L4"><span class="pln">      </span><span class="pun">-&gt;</span><span class="pln">andWhere</span><span class="pun">(</span><span class="str">'j.is_activated = :activated'</span><span class="pun">)</span></li><li class="L5"><span class="pln">      </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'activated'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></li><li class="L6"><span class="pln">      </span><span class="pun">-&gt;</span><span class="pln">setMaxResults</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></li><li class="L7"><span class="pln">      </span><span class="pun">-&gt;</span><span class="pln">getQuery</span><span class="pun">();</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">    </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">      $job </span><span class="pun">=</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getSingleResult</span><span class="pun">();</span></li><li class="L1"><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">\Doctrine\Orm\NoResultException $e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">      $job </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span></li><li class="L3"><span class="pln">    </span><span class="pun">}</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> $job</span><span class="pun">;</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span></li><li class="L7"><span class="pun">}</span></li></ol></pre>
<p>Pareil pour la méthode <strong>getWithJobs()</strong> de <strong>CategoryRepository</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Repository/CategoryRepository.php</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="kwd">namespace</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Repository</span><span class="pun">;</span></li><li class="L3"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Doctrine</span><span class="pln">\ORM\EntityRepository</span><span class="pun">;</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="kwd">class</span><span class="pln"> </span><span class="typ">CategoryRepository</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">EntityRepository</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getWithJobs</span><span class="pun">()</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    $query </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getEntityManager</span><span class="pun">()-&gt;</span><span class="pln">createQuery</span><span class="pun">(</span></li><li class="L0"><span class="pln">      </span><span class="str">'SELECT c FROM EnsJobeetBundle:Category c LEFT JOIN c.jobs j WHERE j.expires_at &gt; :date AND j.is_activated = :activated'</span></li><li class="L1"><span class="pln">    </span><span class="pun">)-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()))-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'activated'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getResult</span><span class="pun">();</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pun">}</span></li></ol></pre>
<p>Vous pouvez maintenant le tester dans votre navigateur. Tous les emplois non-activés ont disparu de la page d'accueil, même si vous connaissez son URL, ils ne sont plus accessibles. Ils sont cependant accessibles si l'on connaît le jeton de l'offre. Dans ce cas, l'aperçu de l'offre sera affiché avec la barre d'administration.</p>
<br>
<p class="clearfix noprint">
	<a href="les-tests-fonctionnels.html" class="btn btn-success pull-left">Chapitre précédent</a>
	<a href="testez-vos-formulaires.html" class="btn btn-success pull-right">Chapitre suivant</a>
</p>														<p class="link_source noprint"><a href="http://www.ens.ro/2012/05/17/symfony2-jobeet-day-10-the-forms/" target="_blank">» Lire l'article original</a></p>
																					<br>
                        </section>
					</div>
				</div>
				<hr />
				<footer>
					<p class="tcenter">Tutoriel original par <a href="http://www.ens.ro/2012/03/21/jobeet-tutorial-with-symfony2/" target="_blank">Dragos Holban</a> - Traduit par <a href="https://plus.google.com/109236735134093009460?rel=author" target="_blank">Jonathan Thuau</a> - Le tuto sur <a href="https://github.com/thujohn/Jobeet" target="_blank">github</a></p>
				</footer>
			</div>
		</div>
	</div>
<script src="assets/js/jquery-1.8.2.min.js"></script>
<script src="assets/js/bootstrap.js"></script>
<script src="assets/js/prettify.js"></script>
<script src="assets/js/lang-yaml.js"></script>
<script src="assets/js/shadowbox.js"></script>
<script type="text/javascript">
<!--
jQuery(document).ready(function(){
	Shadowbox.init();
	prettyPrint();
	jQuery('.bs-docs-sidenav').affix({
		offset: {
			top: 150,
			bottom: 270
		}
	});
	jQuery('a[href*=#]').click(function (e) {
		var hash = jQuery(this).attr('href');
		e.preventDefault();
		var dest = 0;
		if (jQuery(this.hash).offset().top > (jQuery(document).height() - jQuery(window).height())){
			dest = jQuery(document).height() - jQuery(window).height();
		}else{
			dest = jQuery(this.hash).offset().top;
		}
		jQuery('html,body').animate({scrollTop:dest}, 1000, 'swing');
	});
});
-->
</script>
</body>
</html>