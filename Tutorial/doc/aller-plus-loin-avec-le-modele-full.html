<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Tuto Jobeet Symfony2 FR :: Démarrage du projet</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" type="text/css" href="assets/css/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="assets/css/bootstrap-responsive.css" />
<link rel="stylesheet" type="text/css" href="assets/css/style.css" />
<link rel="stylesheet" type="text/css" href="assets/css/docs.css" />
<link rel="stylesheet" type="text/css" href="assets/css/prettify.css" />
<link rel="stylesheet" type="text/css" href="assets/css/shadowbox.css" />
<link rel="stylesheet" type="text/css" href="assets/css/print.css" media="print" />
<link rel="shortcut icon" href="assets/img/favicon.ico">
<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

</head>

<body>
	<a href="https://github.com/thujohn/Jobeet" target="_blank" id="gogithub"><img src="assets/img/github.gif" alt="" /></a>
	<div class="navbar navbar-inverse hide-on-desktop show-on-tablets show-on-mobile noprint">
		<div class="navbar-inner noprint">
			<div class="container">
				<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="brand" href="./">Jobeet FR</a>
				<div class="nav-collapse collapse">
					<ul class="nav">
						<li class="sommaire"><a href="sommaire.html"><i class="icon-chevron-right"></i>Sommaire</a></li><li class="demarrage-du-projet"><a href="demarrage-du-projet.html"><i class="icon-chevron-right"></i><strong>[01]</strong> Démarrage du projet</a></li><li class="le-projet"><a href="le-projet.html"><i class="icon-chevron-right"></i><strong>[02]</strong> Le projet</a></li><li class="le-modele-de-donnees"><a href="le-modele-de-donnees.html"><i class="icon-chevron-right"></i><strong>[03]</strong> Le Modèle de Données</a></li><li class="le-controleur-et-la-vue"><a href="le-controleur-et-la-vue.html"><i class="icon-chevron-right"></i><strong>[04]</strong> Le Contrôleur et la Vue</a></li><li class="le-routage"><a href="le-routage.html"><i class="icon-chevron-right"></i><strong>[05]</strong> Le Routage</a></li><li class="active"><a href="aller-plus-loin-avec-le-modele.html"><i class="icon-chevron-right"></i><strong>[06]</strong> Aller plus loin avec le Modèle</a></li><li class="jouons-avec-la-page-categorie"><a href="jouons-avec-la-page-categorie.html"><i class="icon-chevron-right"></i><strong>[07]</strong> Jouons avec les catégories</a></li><li class="les-tests-unitaires"><a href="les-tests-unitaires.html"><i class="icon-chevron-right"></i><strong>[08]</strong> Les tests unitaires</a></li><li class="les-tests-fonctionnels"><a href="les-tests-fonctionnels.html"><i class="icon-chevron-right"></i><strong>[09]</strong> Les tests fonctionnels</a></li><li class="les-formulaires"><a href="les-formulaires.html"><i class="icon-chevron-right"></i><strong>[10]</strong> Les formulaires</a></li><li class="testez-vos-formulaires"><a href="testez-vos-formulaires.html"><i class="icon-chevron-right"></i><strong>[11]</strong> Testez vos formulaires</a></li><li class="le-paquet-admin"><a href="le-paquet-admin.html"><i class="icon-chevron-right"></i><strong>[12]</strong> Le paquet Admin</a></li><li class="securite"><a href="securite.html"><i class="icon-chevron-right"></i><strong>[13]</strong> Sécurité</a></li><li class="flux-de-donnees"><a href="flux-de-donnees.html"><i class="icon-chevron-right"></i><strong>[14]</strong> Flux de données</a></li><li class="services-web"><a href="services-web.html"><i class="icon-chevron-right"></i><strong>[15]</strong> Services Web</a></li><li class="l-envoi-d-email"><a href="l-envoi-d-email.html"><i class="icon-chevron-right"></i><strong>[16]</strong> L'envoi d'email</a></li><li class="la-recherche"><a href="la-recherche.html"><i class="icon-chevron-right"></i><strong>[17]</strong> La recherche</a></li><li class="ajax"><a href="ajax.html"><i class="icon-chevron-right"></i><strong>[18]</strong> AJAX</a></li><li class="internationalisation-et-regionalisation"><a href="internationalisation-et-regionalisation.html"><i class="icon-chevron-right"></i><strong>[19]</strong> Internationalisation et régionalisation</a></li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	<div id="container">
		<div id="bootstrap-docs">
			<header class="jumbotron subhead hide-on-tablets hide-on-mobile" id="overview">
				<div class="container">
					<h1><a href="./">Jobeet FR</a></h1>
					<p class="lead">Le tutoriel pour Symfony2 en français</p>
				</div>
			</header>
			<div class="container">
				<div class="row">
										<div class="span12">
											<section class="justify">
                                            <a href="aller-plus-loin-avec-le-modele.html" class="pull-right btn btn-success hide-on-tablets hide-on-mobile noprint">Vue normale</a><div class="page-header clearfix"><h1 class="pull-left">Aller plus loin avec le Modèle</h1></div>
							<h2>L'objet Query de Doctrine</h2>
<p>Scénario du deuxième chapitre: "Sur la page d'accueil, l'utilisateur voit les dernières offres actives." Mais actuellement, toutes les offres sont affichées, qu'elles soient actives ou non:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Controller/JobController.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">class</span><span class="pln"> </span><span class="typ">JobController</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">Controller</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> indexAction</span><span class="pun">()</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    $em </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getDoctrine</span><span class="pun">()-&gt;</span><span class="pln">getEntityManager</span><span class="pun">();</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">    $entities </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job'</span><span class="pun">)-&gt;</span><span class="pln">findAll</span><span class="pun">();</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">render</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job:index.html.twig'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span></li><li class="L2"><span class="pln">      </span><span class="str">'entities'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $entities</span></li><li class="L3"><span class="pln">    </span><span class="pun">));</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">  </span><span class="com">// ...</span></li><li class="L6"><span class="pun">}</span></li></ol></pre>
<p>Une offre active est une offre de moins de 30 jours. La méthode <strong>$entities = $em-&gt;getRepository('EnsJobeetBundle:Job')-&gt;findAll();</strong> va créer une requête à la BDD pour obtenir toutes les offres. Nous ne spécifions aucune condition, ce qui signifie que tous les enregistrements sont extraits de la BDD.</p>
<p>Changeons cela pour sélectionner uniquement les offres actives:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> indexAction</span><span class="pun">()</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getDoctrine</span><span class="pun">()-&gt;</span><span class="pln">getEntityManager</span><span class="pun">();</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">  $query </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">createQuery</span><span class="pun">(</span></li><li class="L5"><span class="pln">    </span><span class="str">'SELECT j FROM EnsJobeetBundle:Job j WHERE j.created_at &gt; :date'</span></li><li class="L6"><span class="pln">  </span><span class="pun">)-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="lit">86400</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">30</span><span class="pun">));</span></li><li class="L7"><span class="pln">  $entities </span><span class="pun">=</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getResult</span><span class="pun">();</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">render</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job:index.html.twig'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span></li><li class="L0"><span class="pln">    </span><span class="str">'entities'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $entities</span></li><li class="L1"><span class="pln">  </span><span class="pun">));</span></li><li class="L2"><span class="pun">}</span></li></ol></pre>
<br>
<h2>Débuguer les requêtes générées par Doctrine</h2>
<p>Parfois, il est utile de voir les requêtes générées par Doctrine, par exemple, pour débuguer une requête qui ne fonctionne pas comme prévu. Dans l'environnement de dev, grâce à la <strong>Web Debug Toolbar</strong> de Symfony, toutes les informations dont vous avez besoin sont disponibles dans votre navigateur <a href="http://jobeet.local/app_dev.php" target="_blank">http://jobeet.local/app_dev.php</a>):</p>
<p class="tcenter"><a href="assets/img/jobeet_6-1.png" rel="shadowbox"><img src="assets/img/jobeet_6-1.png" alt="" class="img-polaroid"></a></p>
<p class="tcenter"><a href="assets/img/jobeet_6-2.png" rel="shadowbox"><img src="assets/img/jobeet_6-2.png" alt="" class="img-polaroid"></a></p>
<br>
<h2>Sérialisation d'objets</h2>
<p>Même si le code ci-dessus fonctionne, il est loin d'être parfait, car il ne tient pas compte de certains scénarios du deuxième chapitre: "<em>Un utilisateur peut revenir réactiver ou prolonger la validité de l'offre pour une période de 30 jours supplémentaires...</em>"</p>
<p>Mais comme le code ci-dessus ne repose que sur la valeur <strong>created_at</strong>, et parce que cette colonne stocke la date de création, on ne peut pas satisfaire ce scénario.</p>
<p>Si vous vous souvenez du <a href="assets/img/jobeet_3-1.png" rel="shadowbox">schéma de BDD</a> que nous avons décrit dans le troisième chapitre, nous avons aussi défini une colonne <strong>expires_at</strong>. À l'heure actuelle, si cette valeur n'est pas définie dans le fichier d'installation, il reste toujours vide. Mais quand une offre est créée, cette valeur peut être automatiquement réglée à 30 jours après la date du jour.</p>
<p>Lorsque vous avez besoin de faire quelque chose automatiquement avant qu'un objet Doctrine ne soit sérialisé dans la BDD, vous pouvez ajouter une nouvelle entrée <strong>lifecycleCallbacks</strong> dans le fichier qui mappe les objets de la BDD, comme nous l'avons fait précédemment pour la colonne <strong>created_at</strong>:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># src/Ens/JobeetBundle/Resources/config/doctrine/Job.orm.yml</span></li><li class="L1"><span class="com"># ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">  </span><span class="kwd">lifecycleCallbacks:</span></li><li class="L4"><span class="pln">    </span><span class="kwd">prePersist: </span><span class="pln">[ setCreatedAtValue, setExpiresAtValue ]</span></li><li class="L5"><span class="pln">    </span><span class="kwd">preUpdate: </span><span class="pln">[ setUpdatedAtValue ]</span></li></ol></pre>
<p>Maintenant, nous devons reconstruire les classes d'entités afin que Doctrine ajoute la nouvelle fonction:</p>
<pre>php app/console doctrine:generate:entities EnsJobeetBundle</pre>
<p>Ouvrez le fichier <strong>src/Ens/JobeetBundle/Entity/Job.php</strong> et modifiez la nouvelle fonction:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com"># src/Ens/JobeetBundle/Entity/Job.php</span></li><li class="L1"><span class="com"># ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> setExpiresAtValue</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pun">(!</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">getExpiresAt</span><span class="pun">())</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    $now </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getCreatedAt</span><span class="pun">()</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getCreatedAt</span><span class="pun">()-&gt;</span><span class="pln">format</span><span class="pun">(</span><span class="str">'U'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> time</span><span class="pun">();</span></li><li class="L8"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">expires_at </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> \DateTime</span><span class="pun">(</span><span class="pln">date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> $now </span><span class="pun">+</span><span class="pln"> </span><span class="lit">86400</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">30</span><span class="pun">));</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pun">}</span></li></ol></pre>
<p>Maintenant, nous allons modifier l'action pour utiliser la colonne <strong>expires_at</strong> au lieu de <strong>created_at</strong> pour sélectionner les offres actives:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Controller/JobController.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> indexAction</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getDoctrine</span><span class="pun">()-&gt;</span><span class="pln">getEntityManager</span><span class="pun">();</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  $query </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">createQuery</span><span class="pun">(</span></li><li class="L8"><span class="pln">    </span><span class="str">'SELECT j FROM EnsJobeetBundle:Job j WHERE j.expires_at &gt; :date'</span></li><li class="L9"><span class="pln">  </span><span class="pun">)-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()));</span></li><li class="L0"><span class="pln">  $entities </span><span class="pun">=</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getResult</span><span class="pun">();</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">render</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job:index.html.twig'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span></li><li class="L3"><span class="pln">    </span><span class="str">'entities'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $entities</span></li><li class="L4"><span class="pln">  </span><span class="pun">));</span></li><li class="L5"><span class="pun">}</span></li></ol></pre>
<br>
<h2>Aller plus loin avec les fixtures</h2>
<p>L'actualisation de la page d'accueil Jobeet dans votre navigateur ne changera rien car les offres dans la BDD ont été affichées il y a seulement quelques jours. Nous allons changer les fixtures pour ajouter une offre qui est déjà expirée:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/DataFixtures/ORM/LoadJobData.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">$job_expired </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Job</span><span class="pun">();</span></li><li class="L4"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setCategory</span><span class="pun">(</span><span class="pln">$em</span><span class="pun">-&gt;</span><span class="pln">merge</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">getReference</span><span class="pun">(</span><span class="str">'category-programming'</span><span class="pun">)));</span></li><li class="L5"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setType</span><span class="pun">(</span><span class="str">'full-time'</span><span class="pun">);</span></li><li class="L6"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setCompany</span><span class="pun">(</span><span class="str">'Sensio Labs'</span><span class="pun">);</span></li><li class="L7"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setLogo</span><span class="pun">(</span><span class="str">'sensio-labs.gif'</span><span class="pun">);</span></li><li class="L8"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setUrl</span><span class="pun">(</span><span class="str">'http://www.sensiolabs.com/'</span><span class="pun">);</span></li><li class="L9"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setPosition</span><span class="pun">(</span><span class="str">'Web Developer Expired'</span><span class="pun">);</span></li><li class="L0"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setLocation</span><span class="pun">(</span><span class="str">'Paris, France'</span><span class="pun">);</span></li><li class="L1"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setDescription</span><span class="pun">(</span><span class="str">'Lorem ipsum dolor sit amet, consectetur adipisicing elit.'</span><span class="pun">);</span></li><li class="L2"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setHowToApply</span><span class="pun">(</span><span class="str">'Send your resume to lorem.ipsum [at] dolor.sit'</span><span class="pun">);</span></li><li class="L3"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setIsPublic</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L4"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setIsActivated</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L5"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setToken</span><span class="pun">(</span><span class="str">'job_expired'</span><span class="pun">);</span></li><li class="L6"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setEmail</span><span class="pun">(</span><span class="str">'job@example.com'</span><span class="pun">);</span></li><li class="L7"><span class="pln">$job_expired</span><span class="pun">-&gt;</span><span class="pln">setCreatedAt</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> \DateTime</span><span class="pun">(</span><span class="str">'2005-12-01'</span><span class="pun">));</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="com">// ...</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="pln">$em</span><span class="pun">-&gt;</span><span class="pln">persist</span><span class="pun">(</span><span class="pln">$job_expired</span><span class="pun">);</span></li></ol></pre>
<p>Rechargez les fixtures et rafraîchissez votre navigateur pour vous assurer que l'ancienne offre ne s'affiche pas:</p>
<pre>php app/console doctrine:fixtures:load</pre>
<br>
<h2>Refactorisation</h2>
<p>Bien que le code que nous avons écrit fonctionne très bien, ce n'est pas encore parfait. Voyez-vous le problème?</p>
<p>La requête Doctrine n'appartient pas à l'action (la couche Contrôleur), il appartient à la couche Modèle. Dans le modèle MVC, le Modèle définit toute la logique métier, et le Contrôleur appelle le Modèle pour récupérer les données qu'il contient. Comme le code renvoie une collection d'offres, déplaçons le code vers le Modèle. Pour cela, nous devons créer une classe de dépôt personnalisée pour l'entité <strong>Job</strong> et ajouter la requête à cette classe.</p>
<p>Ouvrez <strong>/src/Ens/JobeetBundle/Resources/config/doctrine/Job.orm.yml</strong> et ajoutez ce qui suit:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># /src/Ens/JobeetBundle/Resources/config/doctrine/Job.orm.yml</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">Ens\JobeetBundle\Entity\</span><span class="kwd">Job:</span></li><li class="L3"><span class="pln">  </span><span class="kwd">type: </span><span class="pln">entity</span></li><li class="L4"><span class="pln">  </span><span class="kwd">repositoryClass: </span><span class="pln">Ens\JobeetBundle\Repository\JobRepository</span></li><li class="L5"><span class="pln">  </span><span class="com"># ...</span></li></ol></pre>
<p>Doctrine peut générer la classe de dépôt pour vous en exécutant la commande <strong>generate:entities</strong> utilisée précédemment:</p>
<pre>php app/console doctrine:generate:entities EnsJobeetBundle</pre>
<p>Ensuite, ajoutez une nouvelle méthode - <strong>getActiveJobs()</strong> - à la classe de dépôt nouvellement générée. Cette méthode va récupérer toutes les entités <strong>Job</strong> actives triées par la colonne <strong>expires_at</strong> (et filtrées par catégorie si elle reçoit le paramètre <strong>$category_id</strong>).</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Repository/JobRepository.php</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="kwd">namespace</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Repository</span><span class="pun">;</span></li><li class="L3"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Doctrine</span><span class="pln">\ORM\EntityRepository</span><span class="pun">;</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="kwd">class</span><span class="pln"> </span><span class="typ">JobRepository</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">EntityRepository</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getActiveJobs</span><span class="pun">(</span><span class="pln">$category_id </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    $qb </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createQueryBuilder</span><span class="pun">(</span><span class="str">'j'</span><span class="pun">)</span></li><li class="L0"><span class="pln">      </span><span class="pun">-&gt;</span><span class="kwd">where</span><span class="pun">(</span><span class="str">'j.expires_at &gt; :date'</span><span class="pun">)</span></li><li class="L1"><span class="pln">      </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()))</span></li><li class="L2"><span class="pln">      </span><span class="pun">-&gt;</span><span class="pln">orderBy</span><span class="pun">(</span><span class="str">'j.expires_at'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'DESC'</span><span class="pun">);</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">$category_id</span><span class="pun">)</span></li><li class="L5"><span class="pln">    </span><span class="pun">{</span></li><li class="L6"><span class="pln">      $qb</span><span class="pun">-&gt;</span><span class="pln">andWhere</span><span class="pun">(</span><span class="str">'j.category = :category_id'</span><span class="pun">)</span></li><li class="L7"><span class="pln">         </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'category_id'</span><span class="pun">,</span><span class="pln"> $category_id</span><span class="pun">);</span></li><li class="L8"><span class="pln">    </span><span class="pun">}</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">    $query </span><span class="pun">=</span><span class="pln"> $qb</span><span class="pun">-&gt;</span><span class="pln">getQuery</span><span class="pun">();</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getResult</span><span class="pun">();</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li></ol></pre>
<p>Maintenant, le code de l'action peut utiliser cette nouvelle méthode pour récupérer les offres actives.</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Controller/JobController.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> indexAction</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getDoctrine</span><span class="pun">()-&gt;</span><span class="pln">getEntityManager</span><span class="pun">();</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  $entities </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job'</span><span class="pun">)-&gt;</span><span class="pln">getActiveJobs</span><span class="pun">();</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">render</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job:index.html.twig'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span></li><li class="L0"><span class="pln">    </span><span class="str">'entities'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $entities</span></li><li class="L1"><span class="pln">  </span><span class="pun">));</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="com">// ...</span></li></ol></pre>
<p>Cette refactorisation a plusieurs avantages par rapport au code précédent:</p>
<ul class="unstyled">
	<li>- La logique pour obtenir les offres actives est maintenant dans le Modèle, où elle appartient</li>
	<li>- Le code du Contrôleur est plus mince et beaucoup plus lisible</li>
	<li>- La méthode getActiveJobs() est ré-utilisable (par exemple dans une autre action)</li>
	<li>- Le code du modèle est désormais testable unitairement</li>
</ul>
<br>
<h2>Les catégories sur la page d'accueil</h2>
<p>Conformément aux scénarios du deuxième chapitre, nous avons besoin d'avoir des offres classées par catégories. Jusqu'à présent, nous n'avons pas pris la notion de catégorie d'offre en compte. Selon les scénarios, la page d'accueil doit afficher les offres par catégorie. Tout d'abord, nous avons besoin de toutes les catégories avec au moins une offre.</p>
<p>Créez une classe de dépôt pour l'entité <strong>Category</strong> comme nous l'avons fait pour <strong>Job</strong>:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># /src/Ens/JobeetBundle/Resources/config/doctrine/Category.orm.yml</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">Ens\JobeetBundle\Entity\</span><span class="kwd">Category:</span></li><li class="L3"><span class="pln">  </span><span class="kwd">type: </span><span class="pln">entity</span></li><li class="L4"><span class="pln">  </span><span class="kwd">repositoryClass: </span><span class="pln">Ens\JobeetBundle\Repository\CategoryRepository</span></li><li class="L5"><span class="pln">  </span><span class="com">#...</span></li></ol></pre>
<p>Générez la classe de dépôt:</p>
<pre>php app/console doctrine:generate:entities EnsJobeetBundle</pre>
<p>Ouvrez la classe <strong>CategoryRepository</strong> et ajoutez une méthode <strong>getWithJobs()</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Repository/CategoryRepository.php</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="kwd">namespace</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Repository</span><span class="pun">;</span></li><li class="L3"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Doctrine</span><span class="pln">\ORM\EntityRepository</span><span class="pun">;</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="kwd">class</span><span class="pln"> </span><span class="typ">CategoryRepository</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">EntityRepository</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getWithJobs</span><span class="pun">()</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    $query </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getEntityManager</span><span class="pun">()-&gt;</span><span class="pln">createQuery</span><span class="pun">(</span></li><li class="L0"><span class="pln">      </span><span class="str">'SELECT c FROM EnsJobeetBundle:Category c LEFT JOIN c.jobs j WHERE j.expires_at &gt; :date'</span></li><li class="L1"><span class="pln">    </span><span class="pun">)-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()));</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getResult</span><span class="pun">();</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pun">}</span></li></ol></pre>
<p>Modifiez l'action <strong>index</strong> en conséquence:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> indexAction</span><span class="pun">()</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getDoctrine</span><span class="pun">()-&gt;</span><span class="pln">getEntityManager</span><span class="pun">();</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">  $categories </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Category'</span><span class="pun">)-&gt;</span><span class="pln">getWithJobs</span><span class="pun">();</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln">  </span><span class="kwd">foreach</span><span class="pun">(</span><span class="pln">$categories </span><span class="kwd">as</span><span class="pln"> $category</span><span class="pun">)</span></li><li class="L7"><span class="pln">  </span><span class="pun">{</span></li><li class="L8"><span class="pln">    $category</span><span class="pun">-&gt;</span><span class="pln">setActiveJobs</span><span class="pun">(</span><span class="pln">$em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job'</span><span class="pun">)-&gt;</span><span class="pln">getActiveJobs</span><span class="pun">(</span><span class="pln">$category</span><span class="pun">-&gt;</span><span class="pln">getId</span><span class="pun">()));</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">render</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job:index.html.twig'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span></li><li class="L2"><span class="pln">    </span><span class="str">'categories'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $categories</span></li><li class="L3"><span class="pln">  </span><span class="pun">));</span></li><li class="L4"><span class="pun">}</span></li></ol></pre>
<p>Pour que cela fonctionne, nous devons ajouter une nouvelle propriété à notre classe <strong>Category</strong>, les <strong>active_jobs</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Entity/Category.php</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="kwd">namespace</span><span class="pln"> </span><span class="typ">Ens</span><span class="pln">\JobeetBundle\Entity</span><span class="pun">;</span></li><li class="L3"><span class="kwd">use</span><span class="pln"> </span><span class="typ">Doctrine</span><span class="pln">\ORM\Mapping </span><span class="kwd">as</span><span class="pln"> ORM</span><span class="pun">;</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="kwd">class</span><span class="pln"> </span><span class="typ">Category</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="com">// ...</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">  </span><span class="kwd">private</span><span class="pln"> $active_jobs</span><span class="pun">;</span></li><li class="L0"><span class="pln"> </span></li><li class="L1"><span class="pln">  </span><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> setActiveJobs</span><span class="pun">(</span><span class="pln">$jobs</span><span class="pun">)</span></li><li class="L4"><span class="pln">  </span><span class="pun">{</span></li><li class="L5"><span class="pln">    $this</span><span class="pun">-&gt;</span><span class="pln">active_jobs </span><span class="pun">=</span><span class="pln"> $jobs</span><span class="pun">;</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getActiveJobs</span><span class="pun">()</span></li><li class="L9"><span class="pln">  </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">active_jobs</span><span class="pun">;</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pun">}</span></li></ol></pre>
<p>Dans le template, nous avons besoin de parcourir toutes les catégories et afficher les offres actives:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">&lt;!-- src/Ens/JobeetBundle/Resources/views/Job/index.html.twig --&gt;</span></li><li class="L1"><span class="com">&lt;!-- ... --&gt;</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">{% block content %}</span></li><li class="L4"><span class="pln">  </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"jobs"</span><span class="tag">&gt;</span></li><li class="L5"><span class="pln">    {% for category in categories %}</span></li><li class="L6"><span class="pln">      </span><span class="tag">&lt;div&gt;</span></li><li class="L7"><span class="pln">        </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"category"</span><span class="tag">&gt;</span></li><li class="L8"><span class="pln">          </span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"feed"</span><span class="tag">&gt;</span></li><li class="L9"><span class="pln">            </span><span class="tag">&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">""</span><span class="tag">&gt;</span><span class="pln">Feed</span><span class="tag">&lt;/a&gt;</span></li><li class="L0"><span class="pln">          </span><span class="tag">&lt;/div&gt;</span></li><li class="L1"><span class="pln">          </span><span class="tag">&lt;h1&gt;</span><span class="pln">{{ category.name }}</span><span class="tag">&lt;/h1&gt;</span></li><li class="L2"><span class="pln">        </span><span class="tag">&lt;/div&gt;</span></li><li class="L3"><span class="pln">        </span><span class="tag">&lt;table</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"jobs"</span><span class="tag">&gt;</span></li><li class="L4"><span class="pln">          {% for entity in category.activejobs %}</span></li><li class="L5"><span class="pln">            </span><span class="tag">&lt;tr</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"{{ cycle(['even', 'odd'], loop.index) }}"</span><span class="tag">&gt;</span></li><li class="L6"><span class="pln">              </span><span class="tag">&lt;td</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"location"</span><span class="tag">&gt;</span><span class="pln">{{ entity.location }}</span><span class="tag">&lt;/td&gt;</span></li><li class="L7"><span class="pln">              </span><span class="tag">&lt;td</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"position"</span><span class="tag">&gt;</span></li><li class="L8"><span class="pln">                </span><span class="tag">&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"{{ path('ens_job_show', { 'id': entity.id, 'company': entity.companyslug, 'location': entity.locationslug, 'position': entity.positionslug }) }}"</span><span class="tag">&gt;</span></li><li class="L9"><span class="pln">                  {{ entity.position }}</span></li><li class="L0"><span class="pln">                </span><span class="tag">&lt;/a&gt;</span></li><li class="L1"><span class="pln">              </span><span class="tag">&lt;/td&gt;</span></li><li class="L2"><span class="pln">              </span><span class="tag">&lt;td</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"company"</span><span class="tag">&gt;</span><span class="pln">{{ entity.company }}</span><span class="tag">&lt;/td&gt;</span></li><li class="L3"><span class="pln">            </span><span class="tag">&lt;/tr&gt;</span></li><li class="L4"><span class="pln">          {% endfor %}</span></li><li class="L5"><span class="pln">        </span><span class="tag">&lt;/table&gt;</span></li><li class="L6"><span class="pln">      </span><span class="tag">&lt;/div&gt;</span></li><li class="L7"><span class="pln">    {% endfor %}</span></li><li class="L8"><span class="pln">  </span><span class="tag">&lt;/div&gt;</span></li><li class="L9"><span class="pln">{% endblock %}</span></li></ol></pre>
<br>
<h2>Limiter les résultats</h2>
<p>Il reste encore une condition à implémenter pour la liste des offres dans la page d'accueil: il faut limiter la liste des offres à 10 articles. Il est assez simple d'ajouter le paramètre <strong>$max</strong> à la méthode <strong>JobRepository::getActiveJobs()</strong></p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getActiveJobs</span><span class="pun">(</span><span class="pln">$category_id </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> $max </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  $qb </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createQueryBuilder</span><span class="pun">(</span><span class="str">'j'</span><span class="pun">)</span></li><li class="L3"><span class="pln">    </span><span class="pun">-&gt;</span><span class="kwd">where</span><span class="pun">(</span><span class="str">'j.expires_at &gt; :date'</span><span class="pun">)</span></li><li class="L4"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()))</span></li><li class="L5"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">orderBy</span><span class="pun">(</span><span class="str">'j.expires_at'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'DESC'</span><span class="pun">);</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">$max</span><span class="pun">)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    $qb</span><span class="pun">-&gt;</span><span class="pln">setMaxResults</span><span class="pun">(</span><span class="pln">$max</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">  </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">$category_id</span><span class="pun">)</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">    $qb</span><span class="pun">-&gt;</span><span class="pln">andWhere</span><span class="pun">(</span><span class="str">'j.category = :category_id'</span><span class="pun">)</span></li><li class="L5"><span class="pln">       </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'category_id'</span><span class="pun">,</span><span class="pln"> $category_id</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln">  $query </span><span class="pun">=</span><span class="pln"> $qb</span><span class="pun">-&gt;</span><span class="pln">getQuery</span><span class="pun">();</span></li><li class="L9"><span class="pln"> </span></li><li class="L0"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getResult</span><span class="pun">();</span></li><li class="L1"><span class="pun">}</span></li></ol></pre>
<p>Changez l'appel à <strong>getActiveJobs</strong> afin d'inclure le paramètre <strong>$max</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Controller/JobController.php</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">$category</span><span class="pun">-&gt;</span><span class="pln">setActiveJobs</span><span class="pun">(</span><span class="pln">$em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job'</span><span class="pun">)-&gt;</span><span class="pln">getActiveJobs</span><span class="pun">(</span><span class="pln">$category</span><span class="pun">-&gt;</span><span class="pln">getId</span><span class="pun">(),</span><span class="pln"> </span><span class="lit">10</span><span class="pun">));</span></li></ol></pre>
<br>
<h2>Configuration personnalisée</h2>
<p>Dans la méthode <strong>indexAction</strong> de <strong>JobController</strong>, nous avons fixé le nombre d'offres maximum retournées pour une catégorie. Il aurait été préférable de laisser la limite de 10 configurable. Dans Symfony, vous pouvez définir des paramètres personnalisés pour votre application dans le fichier <strong>app/config/config.yml</strong>, sous l'entrée <strong>parameters</strong>:</p>
<pre class="prettyprint linenums lang-yaml"><ol class="linenums"><li class="L0"><span class="com"># app/config/config.yml</span></li><li class="L1"><span class="com"># ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">parameters:</span></li><li class="L4"><span class="pln">    </span><span class="kwd">max_jobs_on_homepage: </span><span class="pln">10</span></li></ol></pre>
<p>Cela est maintenant accessible dans un contrôleur:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Controller/JobController</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> indexAction</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $em </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">getDoctrine</span><span class="pun">()-&gt;</span><span class="pln">getEntityManager</span><span class="pun">();</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  $categories </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Category'</span><span class="pun">)-&gt;</span><span class="pln">getWithJobs</span><span class="pun">();</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">  </span><span class="kwd">foreach</span><span class="pun">(</span><span class="pln">$categories </span><span class="kwd">as</span><span class="pln"> $category</span><span class="pun">)</span></li><li class="L0"><span class="pln">  </span><span class="pun">{</span></li><li class="L1"><span class="pln">    $category</span><span class="pun">-&gt;</span><span class="pln">setActiveJobs</span><span class="pun">(</span><span class="pln">$em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job'</span><span class="pun">)-&gt;</span><span class="pln">getActiveJobs</span><span class="pun">(</span><span class="pln">$category</span><span class="pun">-&gt;</span><span class="pln">getId</span><span class="pun">(),</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">container</span><span class="pun">-&gt;</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">'max_jobs_on_homepage'</span><span class="pun">)));</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">render</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job:index.html.twig'</span><span class="pun">,</span><span class="pln"> array</span><span class="pun">(</span></li><li class="L5"><span class="pln">    </span><span class="str">'categories'</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> $categories</span></li><li class="L6"><span class="pln">  </span><span class="pun">));</span></li><li class="L7"><span class="pun">}</span></li></ol></pre>
<br>
<h2>Fixtures dynamiques</h2>
<p>Pour l'instant, vous ne verrez aucune différence parce que nous avons une très petite quantité d'offres dans notre BDD. Nous avons besoin d'ajouter un tas d'offres à la fixture. Ainsi, vous pouvez copier et coller des offres existantes, dix ou vingt fois à la main... mais il y a une meilleure façon. La duplication est une mauvais solution, même pour les fichiers fixture:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/DataFixtures/ORM/LoadJobData.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> load</span><span class="pun">(</span><span class="typ">ObjectManager</span><span class="pln"> $em</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="com">// ...</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln">  </span><span class="kwd">for</span><span class="pun">(</span><span class="pln">$i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">100</span><span class="pun">;</span><span class="pln"> $i </span><span class="pun">&lt;=</span><span class="pln"> </span><span class="lit">130</span><span class="pun">;</span><span class="pln"> $i</span><span class="pun">++)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    $job </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Job</span><span class="pun">();</span></li><li class="L0"><span class="pln">    $job</span><span class="pun">-&gt;</span><span class="pln">setCategory</span><span class="pun">(</span><span class="pln">$em</span><span class="pun">-&gt;</span><span class="pln">merge</span><span class="pun">(</span><span class="pln">$this</span><span class="pun">-&gt;</span><span class="pln">getReference</span><span class="pun">(</span><span class="str">'category-programming'</span><span class="pun">)));</span></li><li class="L1"><span class="pln">    $job</span><span class="pun">-&gt;</span><span class="pln">setType</span><span class="pun">(</span><span class="str">'full-time'</span><span class="pun">);</span></li><li class="L2"><span class="pln">    $job</span><span class="pun">-&gt;</span><span class="pln">setCompany</span><span class="pun">(</span><span class="str">'Company '</span><span class="pun">.</span><span class="pln">$i</span><span class="pun">);</span></li><li class="L3"><span class="pln">    $job</span><span class="pun">-&gt;</span><span class="pln">setPosition</span><span class="pun">(</span><span class="str">'Web Developer'</span><span class="pun">);</span></li><li class="L4"><span class="pln">    $job</span><span class="pun">-&gt;</span><span class="pln">setLocation</span><span class="pun">(</span><span class="str">'Paris, France'</span><span class="pun">);</span></li><li class="L5"><span class="pln">    $job</span><span class="pun">-&gt;</span><span class="pln">setDescription</span><span class="pun">(</span><span class="str">'Lorem ipsum dolor sit amet, consectetur adipisicing elit.'</span><span class="pun">);</span></li><li class="L6"><span class="pln">    $job</span><span class="pun">-&gt;</span><span class="pln">setHowToApply</span><span class="pun">(</span><span class="str">'Send your resume to lorem.ipsum [at] dolor.sit'</span><span class="pun">);</span></li><li class="L7"><span class="pln">    $job</span><span class="pun">-&gt;</span><span class="pln">setIsPublic</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L8"><span class="pln">    $job</span><span class="pun">-&gt;</span><span class="pln">setIsActivated</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L9"><span class="pln">    $job</span><span class="pun">-&gt;</span><span class="pln">setToken</span><span class="pun">(</span><span class="str">'job_'</span><span class="pun">.</span><span class="pln">$i</span><span class="pun">);</span></li><li class="L0"><span class="pln">    $job</span><span class="pun">-&gt;</span><span class="pln">setEmail</span><span class="pun">(</span><span class="str">'job@example.com'</span><span class="pun">);</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln">    $em</span><span class="pun">-&gt;</span><span class="pln">persist</span><span class="pun">(</span><span class="pln">$job</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln">  $em</span><span class="pun">-&gt;</span><span class="pln">flush</span><span class="pun">();</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="com">// ...</span></li></ol></pre>
<p>Vous pouvez maintenant recharger les fixtures avec la commande <strong>doctrine:fixtures:load</strong> et vérifiez que seulement 10 offres sont affichées sur la page d'accueil pour la catégorie <strong>Programming</strong>:</p>
<p class="tcenter"><a href="assets/img/jobeet_6-3.png" rel="shadowbox"><img src="assets/img/jobeet_6-3.png" alt="" class="img-polaroid"></a></p>
<br>
<h2>Sécuriser la page d'offres</h2>
<p>Quand une offre arrive à expiration, même si vous connaissez l'URL, il ne doit pas être possible d'y accéder. Essayez l'URL d'un emploi expiré (remplacez l'<strong>ID</strong> avec l'id réel dans votre BDD - <strong>SELECT id, token FROM jobeet_job WHERE expires_at &lt; NOW()</strong>)</p>
<pre>/app_dev.php/job/sensio-labs/paris-france/ID/web-developer-expired</pre>
<p>Au lieu d'afficher l'offre, nous devons rediriger l'utilisateur vers une page d'erreur 404. Pour cela, nous allons créer une nouvelle fonction dans <strong>JobRepository</strong>:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Repository/JobRepository.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getActiveJob</span><span class="pun">(</span><span class="pln">$id</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  $query </span><span class="pun">=</span><span class="pln"> $this</span><span class="pun">-&gt;</span><span class="pln">createQueryBuilder</span><span class="pun">(</span><span class="str">'j'</span><span class="pun">)</span></li><li class="L6"><span class="pln">    </span><span class="pun">-&gt;</span><span class="kwd">where</span><span class="pun">(</span><span class="str">'j.id = :id'</span><span class="pun">)</span></li><li class="L7"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'id'</span><span class="pun">,</span><span class="pln"> $id</span><span class="pun">)</span></li><li class="L8"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">andWhere</span><span class="pun">(</span><span class="str">'j.expires_at &gt; :date'</span><span class="pun">)</span></li><li class="L9"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">setParameter</span><span class="pun">(</span><span class="str">'date'</span><span class="pun">,</span><span class="pln"> date</span><span class="pun">(</span><span class="str">'Y-m-d H:i:s'</span><span class="pun">,</span><span class="pln"> time</span><span class="pun">()))</span></li><li class="L0"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">setMaxResults</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></li><li class="L1"><span class="pln">    </span><span class="pun">-&gt;</span><span class="pln">getQuery</span><span class="pun">();</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">  </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">    $job </span><span class="pun">=</span><span class="pln"> $query</span><span class="pun">-&gt;</span><span class="pln">getSingleResult</span><span class="pun">();</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">\Doctrine\Orm\NoResultException $e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">    $job </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span></li><li class="L7"><span class="pln">  </span><span class="pun">}</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> $job</span><span class="pun">;</span></li><li class="L0"><span class="pun">}</span></li></ol></pre>
<blockquote><p><em>La méthode <strong>getSingleResult()</strong> renvoie une exception <strong>Doctrine\ORM\NoResultException</strong> si aucun résultat n'est retourné et une exception <strong>Doctrine\ORM\NonUniqueResultException</strong> si plus d'un résultat est retourné. Si vous utilisez cette méthode, vous pouvez avoir besoin de l'envelopper dans un bloc try-catch et de s'assurer qu'un seul résultat est retourné.
</em></p></blockquote>
<p>Maintenant, modifiez <strong>showAction</strong> de <strong>JobController</strong> afin d'utiliser la méthode du nouveau dépôt:</p>
<pre class="prettyprint linenums"><ol class="linenums"><li class="L0"><span class="com">// src/Ens/JobeetBundle/Controller/JobController.php</span></li><li class="L1"><span class="com">// ...</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln">$entity </span><span class="pun">=</span><span class="pln"> $em</span><span class="pun">-&gt;</span><span class="pln">getRepository</span><span class="pun">(</span><span class="str">'EnsJobeetBundle:Job'</span><span class="pun">)-&gt;</span><span class="pln">getActiveJob</span><span class="pun">(</span><span class="pln">$id</span><span class="pun">);</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="com">// ...</span></li></ol></pre>
<p>Maintenant, si vous essayez d'obtenir une offre expirée, vous serez redirigé vers une page 404.</p>
<p class="tcenter"><a href="assets/img/jobeet_6-4.png" rel="shadowbox"><img src="assets/img/jobeet_6-4.png" alt="" class="img-polaroid"></a></p>
<br>
<p class="clearfix noprint">
	<a href="le-routage.html" class="btn btn-success pull-left">Chapitre précédent</a>
	<a href="jouons-avec-la-page-categorie.html" class="btn btn-success pull-right">Chapitre suivant</a>
</p>														<p class="link_source noprint"><a href="http://www.ens.ro/2012/04/08/symfony2-jobeet-day-6-more-with-the-model/" target="_blank">» Lire l'article original</a></p>
																					<br>
													</section>
					</div>
				</div>
				<hr />
				<footer>
					<p class="tcenter">Tutoriel original par <a href="http://www.ens.ro/2012/03/21/jobeet-tutorial-with-symfony2/" target="_blank">Dragos Holban</a> - Traduit par <a href="https://plus.google.com/109236735134093009460?rel=author" target="_blank">Jonathan Thuau</a> - Le tuto sur <a href="https://github.com/thujohn/Jobeet" target="_blank">github</a></p>
				</footer>
			</div>
		</div>
	</div>
<script src="assets/js/jquery-1.8.2.min.js"></script>
<script src="assets/js/bootstrap.js"></script>
<script src="assets/js/prettify.js"></script>
<script src="assets/js/lang-yaml.js"></script>
<script src="assets/js/shadowbox.js"></script>
<script type="text/javascript">
<!--
jQuery(document).ready(function(){
	Shadowbox.init();
	prettyPrint();
	jQuery('.bs-docs-sidenav').affix({
		offset: {
			top: 150,
			bottom: 270
		}
	});
	jQuery('a[href*=#]').click(function (e) {
		var hash = jQuery(this).attr('href');
		e.preventDefault();
		var dest = 0;
		if (jQuery(this.hash).offset().top > (jQuery(document).height() - jQuery(window).height())){
			dest = jQuery(document).height() - jQuery(window).height();
		}else{
			dest = jQuery(this.hash).offset().top;
		}
		jQuery('html,body').animate({scrollTop:dest}, 1000, 'swing');
	});
});
-->
</script>
</body>
</html>